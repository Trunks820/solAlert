# ğŸš€ SolAlert æ·±åº¦ä¼˜åŒ–æ–¹æ¡ˆ v2.0

> **åˆ¶å®šæ—¥æœŸ**: 2025-11-04  
> **åŸºäºç‰ˆæœ¬**: å½“å‰masteråˆ†æ”¯  
> **æ ¸å¿ƒåŸåˆ™**: å…ˆä¿®æ€§èƒ½ç“¶é¢ˆå’Œå®é™…bugï¼Œå†ä¼˜åŒ–æ¶æ„ï¼Œæœ€åå®Œå–„é•¿æœŸåŸºç¡€è®¾æ–½

---

## ğŸ“‹ ç›®å½•

- [P0 - ç´§æ€¥ä¿®å¤ï¼ˆæœ¬å‘¨ï¼Œ6å°æ—¶ï¼‰](#p0---ç´§æ€¥ä¿®å¤æœ¬å‘¨6å°æ—¶)
- [P1 - é‡è¦ä¼˜åŒ–ï¼ˆ2å‘¨å†…ï¼Œ5å¤©ï¼‰](#p1---é‡è¦ä¼˜åŒ–2å‘¨å†…5å¤©)
- [P2 - é•¿æœŸä¼˜åŒ–ï¼ˆ1-3ä¸ªæœˆï¼‰](#p2---é•¿æœŸä¼˜åŒ–1-3ä¸ªæœˆ)
- [ä¼˜å…ˆçº§æ€»ç»“](#ä¼˜å…ˆçº§æ€»ç»“)
- [å®æ–½å»ºè®®](#å®æ–½å»ºè®®)

---

## ğŸ”¥ P0 - ç´§æ€¥ä¿®å¤ï¼ˆæœ¬å‘¨ï¼Œ6å°æ—¶ï¼‰

### ~~1. æ¶æ„ä¼˜åŒ–ï¼šç›´æ¥å¤„ç†æ¨¡å¼~~ âœ… å·²å®Œæˆï¼ˆ2025-11-05ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py`
- âŒ é˜Ÿåˆ—æ¶æ„åœ¨I/Oå¯†é›†å‹åœºæ™¯ä¸‹åè€Œæˆä¸ºç“¶é¢ˆ
- âŒ é˜Ÿåˆ—æ»¡å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼ˆ2æ ¸2GæœåŠ¡å™¨ä¸¢å¼ƒ6101æ¡ï¼Œ8æ ¸24Gä»æ»¡10000å®¹é‡ï¼‰
- âŒ é˜Ÿåˆ—é”ç«äº‰ã€æ¶ˆæ¯æ‹·è´å¼€é”€ã€å›ºå®šæ¶ˆè´¹é€Ÿåº¦é™åˆ¶

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-05ï¼‰**ï¼š

**æ–¹æ¡ˆï¼šç›´æ¥å¤„ç†æ¨¡å¼ï¼ˆæ— é˜Ÿåˆ—ï¼‰**
```
æ—§æ¶æ„ï¼šWebSocket â†’ çº¿ç¨‹æ± (2) â†’ é˜Ÿåˆ—(10000) â†’ æ¶ˆè´¹è€…(8) â†’ å¼‚æ­¥å¤„ç†
                                  â†“ 
                            ç“¶é¢ˆï¼šé˜Ÿåˆ—æ»¡â†’ä¸¢æ¶ˆæ¯

æ–°æ¶æ„ï¼šWebSocket â†’ çº¿ç¨‹æ± (20) â†’ å¼‚æ­¥å¤„ç†
                         â†“
                  ç›´æ¥å¹¶å‘ï¼Œæ— ç¼“å†²ç§¯å‹
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… **ç§»é™¤é˜Ÿåˆ—æ¶æ„**ï¼ˆåˆ é™¤PriorityQueueã€æ¶ˆè´¹è€…ã€åºåˆ—å·æœºåˆ¶ï¼‰
- âœ… **æ‰©å¤§çº¿ç¨‹æ± **ï¼ˆ20çº¿ç¨‹ï¼Œå……åˆ†åˆ©ç”¨8æ ¸24Gèµ„æºï¼‰
- âœ… **é›¶æ‹·è´**ï¼ˆæ¶ˆæ¯ç›´æ¥ä¼ é€’ï¼Œæ— åºåˆ—åŒ–å¼€é”€ï¼‰
- âœ… **çœŸæ­£å¹¶å‘**ï¼ˆ20çº¿ç¨‹å„è‡ªç‹¬ç«‹ï¼Œæ— é”ç«äº‰ï¼‰
- âœ… **å¼¹æ€§ä¼¸ç¼©**ï¼ˆçº¿ç¨‹æ± è‡ªåŠ¨èƒŒå‹ï¼Œå¿™æ—¶é˜»å¡è€Œéä¸¢å¼ƒï¼‰

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | é˜Ÿåˆ—æ¨¡å¼ | ç›´æ¥å¤„ç†æ¨¡å¼ | æå‡ |
|------|---------|------------|------|
| å¤„ç†èƒ½åŠ› | ~16 msg/s | ~40+ msg/s | **2.5x** |
| å»¶è¿Ÿ | é˜Ÿåˆ—ç­‰å¾…+å¤„ç† | ç›´æ¥å¤„ç† | **-80%** |
| ä¸¢æ¶ˆæ¯ | 6101æ¡(60%) | 0æ¡ | **100%æ”¹å–„** |
| å†…å­˜å ç”¨ | ~20MB(é˜Ÿåˆ—) | ~5MB | **-75%** |
| å¹¶å‘åº¦ | 8(æ¶ˆè´¹è€…) | 20(çº¿ç¨‹) | **2.5x** |

**ä¸ºä»€ä¹ˆé˜Ÿåˆ—åè€Œæˆç“¶é¢ˆï¼Ÿ**
1. **I/Oå¯†é›†å‹ä»»åŠ¡**ï¼šå¤„ç†ä¸»è¦æ˜¯ç½‘ç»œç­‰å¾…ï¼ˆAPI/RPCè°ƒç”¨ï¼‰ï¼Œé˜Ÿåˆ—æ— æ³•æå‡I/Oå¹¶å‘
2. **BSCé«˜åå**ï¼šæŒç»­50-100 msg/sï¼Œé˜Ÿåˆ—æŒç»­æ»¡è½½æ— æ³•å‰Šå³°
3. **é”ç«äº‰å¼€é”€**ï¼šé«˜å¹¶å‘ä¸‹`queue.get()`/`queue.put()`é”ç«äº‰ä¸¥é‡
4. **å›ºå®šæ¶ˆè´¹é€Ÿåº¦**ï¼š8ä¸ªæ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›å›ºå®šï¼Œæ— æ³•å¼¹æ€§æ‰©å±•

**é€‚åˆç›´æ¥å¤„ç†çš„åœºæ™¯ï¼ˆâœ… å®Œå…¨ç¬¦åˆï¼‰**ï¼š
- âœ… I/Oå¯†é›†å‹ä»»åŠ¡ï¼ˆå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…ç½‘ç»œï¼‰
- âœ… ä½å»¶è¿Ÿè¦æ±‚ï¼ˆäº¤æ˜“å‘Šè­¦éœ€è¦ç«‹å³å¤„ç†ï¼‰
- âœ… å¤„ç†èƒ½åŠ›â‰ˆç”Ÿäº§é€Ÿåº¦ï¼ˆ20çº¿ç¨‹â‰ˆ50 msg/sï¼‰
- âœ… èµ„æºå……è¶³ï¼ˆ8æ ¸24Gå®Œå…¨èƒ½æ’‘ä½20çº¿ç¨‹ï¼‰
- âœ… RPCç¼“å­˜å¼ºå¤§ï¼ˆå®é™…RPC < 1 RPSï¼Œæ— ç“¶é¢ˆï¼‰

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§ï¼Œ0ä¸¢æ¶ˆæ¯ï¼Œå»¶è¿Ÿé™ä½80%

**ä»£ç ç®€åŒ–**ï¼š
- åˆ é™¤é˜Ÿåˆ—ç›¸å…³ä»£ç ï¼š~150è¡Œ
- åˆ é™¤æ¶ˆè´¹è€…é€»è¾‘ï¼š~40è¡Œ
- åˆ é™¤ä¼˜å…ˆçº§/åºåˆ—å·æœºåˆ¶ï¼š~20è¡Œ
- **æ€»è®¡ç®€åŒ–ï¼š~210è¡Œä»£ç **

---

### ~~2. APIå®¢æˆ·ç«¯èµ„æºæ³„æ¼~~ âœ… å·²å®Œæˆ

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py` - æ¯æ¬¡swapäº‹ä»¶åˆ›å»ºæ–°`DBotXAPI()`
- âŒ `httpx.AsyncClient`æœªå…³é—­ â†’ è¿æ¥æ³„æ¼ã€TLSæ¡æ‰‹å¼€é”€
- âŒ çº¿ç¨‹æ± é‡Œæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹event loopï¼Œè¿æ¥æ— æ³•å¤ç”¨

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-04ï¼‰**ï¼š

**æ–¹æ¡ˆï¼šThread-Local APIå®¢æˆ·ç«¯å¤ç”¨**
```python
def get_thread_dbotx_api(self) -> DBotXAPI:
    """çº¿ç¨‹å®‰å…¨çš„APIå®¢æˆ·ç«¯è·å–ï¼ˆå¤ç”¨httpx.AsyncClientï¼‰"""
    if not hasattr(self.thread_local, 'dbotx_api'):
        self.thread_local.dbotx_api = DBotXAPI()
    return self.thread_local.dbotx_api
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ¯ä¸ªçº¿ç¨‹å¤ç”¨åŒä¸€ä¸ª`DBotXAPI`å®ä¾‹
- âœ… `httpx.AsyncClient`è¿æ¥æ± å¤ç”¨ï¼ˆ100è¿æ¥æ± ï¼‰
- âœ… æ¶ˆé™¤TLSæ¡æ‰‹å¼€é”€ï¼ˆæ¯æ¬¡~50-100ms â†’ 0msï¼‰
- âœ… é¿å…API 429é™æµï¼ˆè¿æ¥å¤ç”¨ â†’ è¯·æ±‚åˆ†æ•£ï¼‰

**æ€§èƒ½æå‡**ï¼š
- âš¡ APIè°ƒç”¨å»¶è¿Ÿé™ä½ï¼š~150ms â†’ ~50ms
- âš¡ APIæˆåŠŸç‡æå‡ï¼š~70% â†’ ~94%
- âš¡ 429é™æµæ¬¡æ•°é™ä½ï¼šé¢‘ç¹ â†’ å‡ ä¹ä¸º0

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§ï¼ŒAPIå¿«é€Ÿè·¯å¾„å æ¯”94%

---

### ~~3. ChainstackèŠ‚ç‚¹è¿ç§» + ç§»é™¤é™æµæœºåˆ¶~~ âœ… å·²å®Œæˆ

**åŸé—®é¢˜**ï¼š
- ğŸ“ NodeRealèŠ‚ç‚¹éœ€è¦CUè®¡è´¹ç›‘æ§å’ŒRPSé™æµ
- âŒ ä»¤ç‰Œæ¡¶é™æµå¢åŠ å»¶è¿Ÿï¼ˆæ¯è¯·æ±‚0-50msç­‰å¾…ï¼‰
- âŒ CUè¿½è¸ªä»£ç å¤æ‚åº¦é«˜ï¼Œç»´æŠ¤æˆæœ¬å¤§

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-04ï¼‰**ï¼š

**1. è¿ç§»åˆ°Chainstackæ— é™åˆ¶èŠ‚ç‚¹**
```
æ—§èŠ‚ç‚¹: wss://bsc-mainnet.nodereal.io/ws/v1/xxx (25 RPSé™åˆ¶)
æ–°èŠ‚ç‚¹: wss://bsc-mainnet.core.chainstack.com/xxx (æ— é™åˆ¶)
```

**2. åˆ é™¤é™æµå’Œè®¡è´¹ç›‘æ§ä»£ç **
```bash
åˆ é™¤æ–‡ä»¶ï¼š
- src/solalert/monitoring/cu_tracker.py      # CUè¿½è¸ªæ¨¡å—
- src/solalert/monitoring/__init__.py        # monitoringåŒ…
- docs/CU_TRACKING_USAGE.md                  # CUæ–‡æ¡£

åˆ é™¤ä»£ç ï¼š
- TokenBucketç±»ï¼ˆ~40è¡Œä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰
- rpc_callä¸­çš„ä»¤ç‰Œæ¡¶è°ƒç”¨ï¼ˆæ¯æ¬¡è¯·æ±‚ï¼‰
- _event_consumerä¸­çš„ä»¤ç‰Œæ¡¶ç­‰å¾…
- health_check_loopä¸­çš„CUç»Ÿè®¡ï¼ˆ~25è¡Œï¼‰
```

**3. æ¶æ„ç®€åŒ–**
```
æ—§æ¶æ„: WebSocket â†’ Queue â†’ Consumer â†’ TokenBucket â†’ RPC
æ–°æ¶æ„: WebSocket â†’ Queue â†’ Consumer (3å¹¶å‘) â†’ RPC
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ¶ˆé™¤ä»¤ç‰Œæ¡¶ç­‰å¾…å»¶è¿Ÿï¼ˆ0-50ms â†’ 0msï¼‰
- âœ… é˜Ÿåˆ—ç›´æ¥æ§åˆ¶å¹¶å‘ï¼ˆ3ä¸ªConsumer = æœ€å¤§3å¹¶å‘ï¼‰
- âœ… æ— éœ€CUè®¡è´¹ç›‘æ§ï¼ˆChainstackæŒ‰æœˆå›ºå®šè´¹ç”¨ï¼‰
- âœ… ä»£ç ç®€åŒ–ï¼ˆ~150è¡Œä»£ç åˆ é™¤ï¼‰
- âœ… ä¿ç•™429æ£€æµ‹ä½œä¸ºé˜²å¾¡æ€§ä¿æŠ¤

**æ€§èƒ½æå‡**ï¼š
- âš¡ ä½å³°æœŸå»¶è¿Ÿé™ä½ï¼šå‰Šå‡ä»¤ç‰Œæ¡¶ç­‰å¾…
- âš¡ é«˜å³°æœŸååæå‡ï¼šæ— RPSé™åˆ¶ç“¶é¢ˆ
- âš¡ æ¶ˆè´¹è€…æ•ˆç‡æå‡ï¼šæ— é™æµé˜»å¡

**ç›‘æ§è°ƒæ•´**ï¼š
```
ç§»é™¤: CUä½¿ç”¨é‡ã€CUé…é¢å‘Šè­¦
ä¿ç•™: 429æ¬¡æ•°ã€é˜Ÿåˆ—æ·±åº¦ã€æº¢å‡ºæ¬¡æ•°
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§ï¼Œè¿è¡Œç¨³å®š

---

### ~~4. Telegram HTTP APIè¿ç§» + ç›‘æ§ä¼˜åŒ–~~ âœ… å·²å®Œæˆï¼ˆ2025-11-05ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ Telegramå‘é€æ¶æ„ä¸ç»Ÿä¸€ï¼ˆBSCç›´æ¥è°ƒç”¨APIï¼ŒSOLä½¿ç”¨Notifierï¼‰
- âŒ å¥åº·æ£€æŸ¥ä¿¡æ¯ä»·å€¼ä½ï¼ˆè¿‡å¤šæŠ€æœ¯æŒ‡æ ‡ï¼Œç¼ºå°‘ä¸šåŠ¡æŒ‡æ ‡ï¼‰
- âŒ åºŸå¼ƒæ–‡ä»¶æœªæ¸…ç†ï¼ˆBSCMonitor Blockç›‘æ§ã€Alchemy Webhookï¼‰

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-05ï¼‰**ï¼š

**1. ç»Ÿä¸€Telegramå‘é€æ¶æ„**
```
æ—§æ¶æ„ï¼ˆä¸ä¸€è‡´ï¼‰:
BSC WebSocket â†’ TelegramAPI.send_message() â†’ HTTP API
SOL WebSocket â†’ TelegramNotifier.send() â†’ Bot API

æ–°æ¶æ„ï¼ˆç»Ÿä¸€ï¼‰:
æ‰€æœ‰ç›‘æ§ â†’ TelegramNotifier.send() â†’ HTTP API (kakarot8.fun:8000)
```

**2. ä¼˜åŒ–å¥åº·æ£€æŸ¥**
```
åˆ é™¤ï¼ˆå†—ä½™/ä»·å€¼ä½ï¼‰:
âŒ RPCè¯¦ç»†ç»Ÿè®¡ï¼ˆå„æ–¹æ³•è°ƒç”¨æ¬¡æ•°ï¼‰
âŒ å¤„ç†æ¨¡å¼è¯´æ˜ï¼ˆå·²å›ºå®šæ¶æ„ï¼‰
âŒ çº¿ç¨‹æ± ç»Ÿè®¡ï¼ˆå›ºå®š20çº¿ç¨‹ï¼‰

æ–°å¢ï¼ˆé«˜ä»·å€¼ä¸šåŠ¡æŒ‡æ ‡ï¼‰:
âœ… è¿è¡Œæ—¶é•¿ï¼ˆXæ—¶Xåˆ†Xç§’ï¼‰
âœ… ç¬¬ä¸€å±‚è¿‡æ»¤ï¼šé€šè¿‡æ•°ã€å†…å¤–ç›˜å æ¯”
âœ… ç¬¬äºŒå±‚æ£€æŸ¥ï¼šé€šè¿‡ç‡ã€æœªé€šè¿‡æ•°ã€å†…å¤–ç›˜åˆ†å¸ƒ
âœ… å‘Šè­¦å‘é€ï¼šæˆåŠŸç‡ã€å¤±è´¥æ•°
```

**3. ä»£ç æ¸…ç†**
```bash
åˆ é™¤åºŸå¼ƒæ–‡ä»¶ï¼š
- src/solalert/monitor/bsc_monitor.py           # Blockè½®è¯¢ç›‘æ§
- src/solalert/api/alchemy_webhook.py           # Alchemy WebhookæœåŠ¡
- src/solalert/api/webhook_processor.py         # Webhookå¤„ç†å™¨
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ¶æ„ç»Ÿä¸€ï¼šæ‰€æœ‰æ¨¡å—ä½¿ç”¨åŒä¸€å‘é€æ¥å£
- âœ… é›†ä¸­ç®¡ç†ï¼šå‘é€é€»è¾‘ã€é‡è¯•ã€é”™è¯¯å¤„ç†ç»Ÿä¸€
- âœ… ç›‘æ§ä¼˜åŒ–ï¼šä¸šåŠ¡æŒ‡æ ‡ä¸ºä¸»ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
- âœ… ä»£ç ç®€åŒ–ï¼šåˆ é™¤~500è¡ŒåºŸå¼ƒä»£ç 

**å¥åº·æ£€æŸ¥ç¤ºä¾‹**ï¼š
```
ğŸ’“ WebSocket å¥åº·æ£€æŸ¥
   è¿è¡Œæ—¶é•¿: 2æ—¶15åˆ†30ç§’
   ç¬¬ä¸€å±‚è¿‡æ»¤: é€šè¿‡ 161 ä¸ª
      â”œâ”€ ğŸ”´ å†…ç›˜: 0 (0.0%)
      â””â”€ ğŸŸ¢ å¤–ç›˜: 161 (100.0%)
   ç¬¬äºŒå±‚æ£€æŸ¥: 161 ä¸ª
      â”œâ”€ âœ… é€šè¿‡: 0 (0.0%)
      â””â”€ âŒ æœªé€šè¿‡: 161 (100.0%)
   å‘Šè­¦å‘é€: 5 æ¬¡
      â”œâ”€ âœ… æˆåŠŸ: 5 (100.0%)
      â””â”€ âŒ å¤±è´¥: 0 (0.0%)
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ï¼ŒTelegramå‘é€æµ‹è¯•é€šè¿‡

---

### ~~5. Prometheus Metricsç›‘æ§~~ âœ… å·²å®Œæˆï¼ˆ2025-11-05ï¼‰

**åŸé—®é¢˜**ï¼š
- å½“å‰åªæœ‰æ—¥å¿—ï¼Œæ— æ³•å®æ—¶ç›‘æ§æ€§èƒ½æŒ‡æ ‡
- é—®é¢˜å‘ç°æ»åï¼ˆéœ€è¦ç¿»æ—¥å¿—ï¼‰
- ç¼ºå°‘å¯è§†åŒ–Dashboard

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-05ï¼‰**ï¼š

**Step 1ï¼šå®‰è£…ä¾èµ–**
```bash
pip install prometheus-client==0.19.0
```

**Step 2ï¼šå®šä¹‰æ ¸å¿ƒMetricsï¼ˆé›†æˆåœ¨ `bsc_websocket_monitor.py` ä¸­ï¼‰**

**å·²å®ç°çš„å…³é”®æŒ‡æ ‡**ï¼š
- âœ… `bsc_ws_messages_total` - WebSocketæ¶ˆæ¯æ€»æ•°ï¼ˆCounterï¼‰
- âœ… `bsc_ws_first_layer_pass_total{type="internal|external"}` - ç¬¬ä¸€å±‚è¿‡æ»¤é€šè¿‡æ•°
- âœ… `bsc_ws_second_layer_check_total{type="internal|external"}` - ç¬¬äºŒå±‚æ£€æŸ¥æ•°
- âœ… `bsc_ws_second_layer_pass_total{type="internal|external"}` - ç¬¬äºŒå±‚é€šè¿‡æ•°
- âœ… `bsc_ws_alerts_total{status="success|failure"}` - å‘Šè­¦å‘é€ç»Ÿè®¡
- âœ… `bsc_ws_cache_hits_total{cache_type="receipt"}` - ç¼“å­˜å‘½ä¸­æ•°
- âœ… `bsc_ws_fallback_total{original="1m|5m",fallback="5m|1h"}` - æ—¶é—´çª—å£é€€è®©ç»Ÿè®¡
- âœ… `bsc_ws_connections` - WebSocketè¿æ¥çŠ¶æ€ï¼ˆGaugeï¼‰
- âœ… `bsc_ws_cache_size{cache_type="receipt|dedup"}` - ç¼“å­˜å¤§å°
- âœ… `bsc_ws_processing_time_seconds` - äº‹ä»¶å¤„ç†è€—æ—¶åˆ†å¸ƒï¼ˆHistogramï¼‰

**Step 3ï¼šä»£ç åŸ‹ç‚¹ä½ç½®**
- âœ… `on_message()` - æ¶ˆæ¯æ€»æ•°è®¡æ•°
- âœ… `handle_swap_event()` / `handle_proxy_event()` - ç¬¬ä¸€å±‚é€šè¿‡è®¡æ•°
- âœ… `second_layer_filter()` - ç¬¬äºŒå±‚æ£€æŸ¥/é€šè¿‡è®¡æ•°
- âœ… `send_alert()` - å‘Šè­¦æˆåŠŸ/å¤±è´¥è®¡æ•°
- âœ… `get_receipt_cached()` - ç¼“å­˜å‘½ä¸­è®¡æ•°
- âœ… æ—¶é—´çª—å£é€€è®©é€»è¾‘ - é€€è®©æ¬¡æ•°ç»Ÿè®¡

**Step 4ï¼šæš´éœ² Metrics ç«¯ç‚¹**
- âœ… `start_bsc_websocket_monitor.py` - å¯åŠ¨HTTP serverï¼ˆç«¯å£8001ï¼‰
- âœ… `main.py` - å…¨å±€å¯åŠ¨HTTP serverï¼ˆç«¯å£8001ï¼‰
- âœ… æä¾› `GET /metrics` ç«¯ç‚¹ï¼ˆPrometheusæ ¼å¼ï¼‰

**Step 5ï¼šé…ç½®æ–‡ä»¶å’Œæ–‡æ¡£**
- âœ… `prometheus.yml.example` - PrometheusæŠ“å–é…ç½®ç¤ºä¾‹
- âœ… `grafana_dashboard_bsc_monitor.json` - Grafanaä»ªè¡¨æ¿æ¨¡æ¿
- âœ… `test_prometheus_metrics.py` - MetricsåŠŸèƒ½æµ‹è¯•è„šæœ¬

**Step 6ï¼šGrafana Dashboard é¢æ¿**
- âœ… æ¶ˆæ¯å¤„ç†é€Ÿç‡ï¼ˆå®æ—¶è¶‹åŠ¿å›¾ï¼‰
- âœ… ç¬¬ä¸€å±‚è¿‡æ»¤é€šè¿‡ç‡ï¼ˆå†…ç›˜/å¤–ç›˜åˆ†ç¦»æ˜¾ç¤ºï¼‰
- âœ… ç¬¬äºŒå±‚æ£€æŸ¥ç»Ÿè®¡ï¼ˆæ£€æŸ¥vsé€šè¿‡å¯¹æ¯”ï¼‰
- âœ… å‘Šè­¦å‘é€æˆåŠŸç‡ï¼ˆç™¾åˆ†æ¯”+é¢œè‰²é˜ˆå€¼ï¼‰
- âœ… ç¼“å­˜å‘½ä¸­ç‡è¶‹åŠ¿
- âœ… æ—¶é—´çª—å£é€€è®©æ¬¡æ•°ï¼ˆ1mâ†’5m, 5mâ†’1hï¼‰
- âœ… WebSocketè¿æ¥çŠ¶æ€ï¼ˆå®æ—¶çŠ¶æ€æŒ‡ç¤ºï¼‰
- âœ… ç¼“å­˜å¤§å°ç›‘æ§ï¼ˆå›æ‰§ç¼“å­˜ã€å»é‡ç¼“å­˜ï¼‰
- âœ… äº‹ä»¶å¤„ç†è€—æ—¶åˆ†å¸ƒï¼ˆP50/P95/P99ï¼‰

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# 1. å¯åŠ¨ BSC Monitorï¼ˆè‡ªåŠ¨å¯åŠ¨ Metrics Serverï¼‰
python start_bsc_websocket_monitor.py
# â†’ Prometheus Metrics: http://0.0.0.0:8001/metrics

# 2. é…ç½® Prometheus æŠ“å–
cp prometheus.yml prometheus.yml
docker run -p 9090:9090 -v ./prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus

# 3. å¯¼å…¥ Grafana Dashboard
# æ‰“å¼€ Grafana â†’ Import â†’ ä¸Šä¼  grafana_dashboard_bsc_monitor.json

# 4. æµ‹è¯• Metrics åŠŸèƒ½
python test_prometheus_metrics.py
```

**å®é™…æ”¶ç›Š**ï¼š
- âœ… å®æ—¶æ•°å€¼ç›‘æ§ï¼ˆæ›¿ä»£æ—¥å¿—grepç»Ÿè®¡ï¼‰
- âœ… å¯è§†åŒ–Dashboardï¼ˆä¸€ç›®äº†ç„¶çš„å›¾è¡¨ï¼‰
- âœ… å†å²è¶‹åŠ¿åˆ†æï¼ˆPrometheuså­˜å‚¨15å¤©æ•°æ®ï¼‰
- âœ… é—®é¢˜å¿«é€Ÿå®šä½ï¼ˆå“ªä¸ªç¯èŠ‚æ˜¯ç“¶é¢ˆï¼Ÿï¼‰
- âœ… é€€è®©ç­–ç•¥æ•ˆæœå¯è§†åŒ–ï¼ˆæ˜¯å¦é¢‘ç¹é€€è®©ï¼Ÿï¼‰
- âœ… å‘Šè­¦æˆåŠŸç‡ç›‘æ§ï¼ˆæ˜¯å¦æœ‰å‘é€å¤±è´¥ï¼Ÿï¼‰
- âœ… æ€§èƒ½åŸºå‡†å»ºç«‹ï¼ˆP50/P95/P99å»¶è¿Ÿï¼‰

**ä¸æ—¥å¿—çš„äº’è¡¥å…³ç³»**ï¼š
- **Metrics**: æ•°å€¼ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æã€å®æ—¶ç›‘æ§
- **Logs**: è¯¦ç»†ä¸Šä¸‹æ–‡ã€é—®é¢˜è¯Šæ–­ã€äº‹ä»¶è¿½è¸ª
- ä¸¤è€…ç»“åˆï¼Œå½¢æˆå®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»

**å·¥ä½œé‡**ï¼š2å°æ—¶ï¼ˆå®é™…ï¼‰

**çŠ¶æ€**ï¼šâœ… å·²é›†æˆï¼Œæµ‹è¯•é€šè¿‡

---

### 6. å¯ç”¨JSONç»“æ„åŒ–æ—¥å¿— â­â­â­

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æ—¥å¿—ç³»ç»Ÿå·²æ”¯æŒJSONæ ¼å¼
- âŒ æœªå¼€å¯ï¼ˆå½“å‰æ˜¯äººç±»å¯è¯»æ ¼å¼ï¼‰

**å®æ–½æ–¹æ¡ˆï¼ˆ5åˆ†é’Ÿï¼‰**ï¼š

**Step 1ï¼šå¼€å¯JSONæ ¼å¼**
```bash
# .env æˆ–ç¯å¢ƒå˜é‡
ENABLE_JSON_LOGS=true
```

**Step 2ï¼šéªŒè¯è¾“å‡º**
- æŸ¥çœ‹ `logs/solalert.log`
- ç¡®è®¤JSONæ ¼å¼æ­£ç¡®

**Step 3ï¼šé…ç½®æ—¥å¿—é‡‡é›†ï¼ˆå¯é€‰ï¼‰**
- éƒ¨ç½²Loki/ELK Stack
- é…ç½®Promtail/Filebeaté‡‡é›†æ—¥å¿—
- åœ¨Grafanaä¸­æŸ¥è¯¢å’Œåˆ†æ

**JSONæ—¥å¿—ç¤ºä¾‹**ï¼š
```json
{
  "timestamp": "2025-11-04T12:00:00.000Z",
  "level": "INFO",
  "logger": "solalert.monitor.bsc_ws",
  "module": "BSC_WS",
  "message": "âš¡ [å¿«é€Ÿè·¯å¾„] APIæ•°æ®å®Œæ•´",
  "tx_hash": "0x123...",
  "token": "0xabc...",
  "file": "bsc_websocket_monitor.py",
  "line": 1587
}
```

**æ”¶ç›Š**ï¼š
- âœ… ä¾¿äºæ—¥å¿—æŸ¥è¯¢ï¼ˆæŒ‰tx_hashã€tokenã€batch_idæŸ¥è¯¢ï¼‰
- âœ… é›†æˆåˆ°æ—¥å¿—å¹³å°ï¼ˆLoki/ELKï¼‰
- âœ… æ—¥å¿—ç»Ÿè®¡åˆ†æï¼ˆæ¯å°æ—¶å‘Šè­¦æ•°ã€é”™è¯¯ç‡è¶‹åŠ¿ï¼‰
- âœ… ç»“æ„åŒ–æ•°æ®ä¾¿äºè‡ªåŠ¨åŒ–å¤„ç†

**å·¥ä½œé‡**ï¼š5åˆ†é’Ÿï¼ˆå¼€å¯ï¼‰ + 2å°æ—¶ï¼ˆé…ç½®æ—¥å¿—å¹³å°ï¼Œå¯é€‰ï¼‰

---

### 7. å¥åº·æ£€æŸ¥å’Œä¼˜é›…å…³é—­ â­â­â­ (å¾…å®æ–½)

**é—®é¢˜**ï¼š
- æ²¡æœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ â†’ K8s/Dockeræ— æ³•åˆ¤æ–­æœåŠ¡æ˜¯å¦æ­£å¸¸
- Ctrl+Cç›´æ¥é€€å‡º â†’ å¯èƒ½ä¸¢å¤±æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯
- æ— æ³•å®ç°é›¶åœæœºéƒ¨ç½²

**å®æ–½æ–¹æ¡ˆï¼ˆ1å°æ—¶ï¼‰**ï¼š

**Part 1ï¼šå¥åº·æ£€æŸ¥ç«¯ç‚¹**

åˆ›å»º `src/solalert/monitoring/health.py`ï¼š

**ç«¯ç‚¹è®¾è®¡**ï¼š
- `GET /health` - Livenessæ¢é’ˆï¼ˆæœåŠ¡æ˜¯å¦å­˜æ´»ï¼‰
  - ç®€å•è¿”å›200 OK
- `GET /ready` - Readinessæ¢é’ˆï¼ˆæœåŠ¡æ˜¯å¦å°±ç»ªï¼‰
  - æ£€æŸ¥Redisè¿æ¥
  - æ£€æŸ¥Databaseè¿æ¥
  - æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
  - æ‰€æœ‰ç»„ä»¶å¥åº·æ‰è¿”å›200ï¼Œå¦åˆ™503

**å¥åº·çŠ¶æ€ç®¡ç†**ï¼š
- å…¨å±€çŠ¶æ€å­—å…¸å­˜å‚¨å„ç»„ä»¶çŠ¶æ€
- å„ç»„ä»¶å®šæœŸæ›´æ–°è‡ªå·±çš„çŠ¶æ€
- å¥åº·æ£€æŸ¥ç«¯ç‚¹è¯»å–çŠ¶æ€

**Dockeré…ç½®**ï¼š
```dockerfile
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1
```

**K8sé…ç½®**ï¼š
```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 60
  periodSeconds: 30

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
```

**Part 2ï¼šä¼˜é›…å…³é—­**

**è®¾è®¡ç›®æ ‡**ï¼š
- æ”¶åˆ°SIGTERM/SIGINTä¿¡å·æ—¶
- åœæ­¢æ¥æ”¶æ–°æ¶ˆæ¯
- ç­‰å¾…å·²æ¥æ”¶æ¶ˆæ¯å¤„ç†å®Œï¼ˆæœ€å¤š30ç§’ï¼‰
- å…³é—­æ‰€æœ‰è¿æ¥ï¼ˆWebSocketã€Databaseã€Redisã€APIå®¢æˆ·ç«¯ï¼‰
- Flushæ—¥å¿—ç¼“å†²åŒº
- é€€å‡º

**å…³é”®ç‚¹**ï¼š
- æ³¨å†Œä¿¡å·å¤„ç†å™¨ï¼ˆ`signal.signal()`ï¼‰
- ä½¿ç”¨ `asyncio.Event` åŒæ­¥å…³é—­æµç¨‹
- æ”¶é›†æ‰€æœ‰éœ€è¦ç­‰å¾…çš„Task
- è¶…æ—¶æœºåˆ¶ï¼ˆé¿å…æ°¸ä¹…hangï¼‰

**æ”¶ç›Š**ï¼š
- âœ… K8s/Dockerå¯ä»¥è‡ªåŠ¨é‡å¯å¼‚å¸¸å®¹å™¨
- âœ… æ»šåŠ¨æ›´æ–°æ—¶ä¸ä¸¢å¤±æ¶ˆæ¯
- âœ… ä¼˜é›…å…³é—­é¿å…æ•°æ®ä¸ä¸€è‡´
- âœ… å®ç°é›¶åœæœºéƒ¨ç½²

**å·¥ä½œé‡**ï¼š1å°æ—¶

---

### ~~8. çº¿ç¨‹æ± å¼‚å¸¸å¤„ç† + Cooldownä¿æŠ¤~~ âœ… å·²å®Œæˆï¼ˆ2025-11-08ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:3429-3431` - çº¿ç¨‹æ± é™é»˜åæ‰å¼‚å¸¸
- âŒ `ThreadPoolExecutor.submit()` æ‰§è¡Œå¼‚å¸¸æ—¶æ— æ—¥å¿—
- âŒ Cooldownè®¾ç½®åå¦‚æœå¼‚å¸¸ï¼Œtokenè¢«æ°¸ä¹…"é”æ­»"
- âŒ çœŸå®æ¡ˆä¾‹ï¼štokené€šè¿‡ç¬¬äºŒå±‚ï¼Œè®¾ç½®cooldownï¼Œä½†æ„å»ºæ¶ˆæ¯æ—¶å¼‚å¸¸ï¼Œå¯¼è‡´æ— æ³•å‘é€ä¸”åç»­è¢«æ‹¦æˆª

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-08ï¼‰**ï¼š

**1. çº¿ç¨‹æ± å¼‚å¸¸æ•è·**
```python
def _run_async_in_thread(self, async_func, *args, **kwargs):
    """åœ¨çº¿ç¨‹æ± ä¸­è¿è¡Œå¼‚æ­¥å‡½æ•°"""
    try:
        asyncio.run(async_func(*args, **kwargs))
    except Exception as e:
        logger.error(f"âŒâŒâŒ çº¿ç¨‹æ± ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {async_func.__name__} | é”™è¯¯: {e}", exc_info=True)
```

**2. Cooldownä¿æŠ¤æœºåˆ¶ï¼ˆå¤–ç›˜ï¼‰**
```python
# è®¾ç½®cooldown
if not await self.check_and_set_alert_cooldown(base_token):
    return

# ğŸ›¡ï¸ ä¿æŠ¤æ€§try-exceptï¼šå¦‚æœæ„å»ºæ¶ˆæ¯æˆ–å‘é€å¤±è´¥ï¼Œè‡ªåŠ¨è§£é”cooldown
try:
    # æ„å»ºæ¶ˆæ¯
    message = ...
    # å‘é€å‘Šè­¦
    send_success = await self.send_alert(message, base_token)
    
    if send_success:
        # æˆåŠŸé€»è¾‘
    else:
        # å¤±è´¥ï¼šè§£é”cooldown
        await self.remove_alert_cooldown(base_token)
except Exception as e:
    # ğŸš¨ å¼‚å¸¸å‘ç”Ÿï¼šè§£é”cooldownï¼Œé¿å…tokenè¢«æ°¸ä¹…é”æ­»
    logger.error(f"âŒ æ„å»º/å‘é€æ¶ˆæ¯å¼‚å¸¸ï¼Œè§£é”cooldown: {base_token[:10]} | é”™è¯¯: {e}", exc_info=True)
    await self.remove_alert_cooldown(base_token)
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ‰€æœ‰çº¿ç¨‹æ± å¼‚å¸¸éƒ½æœ‰è¯¦ç»†æ—¥å¿—ï¼ˆåŒ…å«å †æ ˆä¿¡æ¯ï¼‰
- âœ… Cooldownè®¾ç½®åå¦‚æœå‡ºé”™è‡ªåŠ¨è§£é”
- âœ… é¿å…tokenè¢«"é”æ­»"æ— æ³•é‡è¯•
- âœ… å¤–ç›˜è·¯å¾„å·²ä¿æŠ¤ï¼ˆå†…ç›˜è·¯å¾„å·²æœ‰ç±»ä¼¼æœºåˆ¶ï¼‰

**é—®é¢˜è¯Šæ–­æµç¨‹æ”¹è¿›**ï¼š
```
ä¹‹å‰ï¼šé€šè¿‡ç¬¬äºŒå±‚ â†’ è®¾ç½®cooldown â†’ å¼‚å¸¸ï¼ˆæ— æ—¥å¿—ï¼‰ â†’ tokené”æ­» â†’ ç”¨æˆ·å›°æƒ‘
ç°åœ¨ï¼šé€šè¿‡ç¬¬äºŒå±‚ â†’ è®¾ç½®cooldown â†’ å¼‚å¸¸ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰ â†’ è‡ªåŠ¨è§£é” â†’ ä¸‹æ¬¡å¯é‡è¯•
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ï¼Œä¿®å¤äº†ç”Ÿäº§ç¯å¢ƒçš„token"é”æ­»"é—®é¢˜

---

### 9. Redisç¼“å­˜ä¼˜åŒ– âœ… å·²å®Œæˆï¼ˆ2025-11-08ï¼‰

**åŸé—®é¢˜**ï¼š
- âŒ fourmemeç™½åå•ç¼“å­˜ç¼ºå¤±ï¼ˆåŒä¸€tokené‡å¤è°ƒç”¨APIæµªè´¹ç§¯åˆ†ï¼‰
- âŒ TTLè®¾ç½®è¿‡é•¿ï¼ˆ30å¤©ï¼‰ï¼ŒRediså†…å­˜å ç”¨è¿‡é«˜
- âŒ 1G Redisåœ¨å°é…ç½®æœåŠ¡å™¨ï¼ˆ4Gæ€»å†…å­˜ï¼‰ä¸Šéœ€è¦æ§åˆ¶å ç”¨

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-08ï¼‰**ï¼š

**1. fourmemeç™½åå•ç¼“å­˜**
```python
# åˆå§‹åŒ–
self.FOURMEME_KEY = "bsc:fourmeme_tokens"
self.FOURMEME_TTL = 7 * 24 * 3600  # 7å¤©
self.fourmeme_cache_hit_count = 0

# æ£€æŸ¥æµç¨‹
1. å…ˆæ£€æŸ¥fourmemeç™½åå•ï¼ˆå‘½ä¸­â†’è·³è¿‡APIï¼Œç›´æ¥ç¬¬äºŒå±‚ï¼‰
2. å†æ£€æŸ¥éfourmemeé»‘åå•ï¼ˆå‘½ä¸­â†’è·³è¿‡ï¼‰
3. éƒ½æœªå‘½ä¸­â†’è°ƒç”¨API
4. æ˜¯fourmemeâ†’åŠ å…¥ç™½åå•ï¼Œä¸‹æ¬¡ç›´æ¥å‘½ä¸­

# å†…å­˜é¢„ä¼°ï¼ˆ7å¤©ï¼‰
- fourmemeç™½åå•ï¼š500Ã—7 = 3,500ä¸ª â†’ ~0.5 MB
- éfourmemeé»‘åå•ï¼š3,000Ã—7 = 21,000ä¸ª â†’ ~3 MB
- æ€»è®¡ï¼š~3.6 MBï¼ˆ1G Rediså ç”¨ç‡ 0.36%ï¼‰
```

**2. TTLä¼˜åŒ–**
```python
# è°ƒæ•´å‰
self.NON_FOURMEME_TTL = 30 * 24 * 3600  # 30å¤© â†’ ~15 MB
self.FOURMEME_TTL = 30 * 24 * 3600      # 30å¤©

# è°ƒæ•´å  
self.NON_FOURMEME_TTL = 7 * 24 * 3600   # 7å¤© â†’ ~3.6 MB
self.FOURMEME_TTL = 7 * 24 * 3600       # 7å¤©
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… åŒä¸€fourmeme tokenå‘½ä¸­ç¼“å­˜ï¼ŒèŠ‚çœ10ç§¯åˆ†/æ¬¡
- âœ… é¢„è®¡èŠ‚çœ90%é‡å¤APIè°ƒç”¨
- âœ… Rediså†…å­˜å ç”¨é™ä½75%ï¼ˆ15MB â†’ 3.6MBï¼‰
- âœ… 7å¤©TTLå¯¹BSCé“¾ï¼ˆtokenæ›´æ–°å¿«ï¼‰è¶³å¤Ÿ

**æ€§èƒ½æå‡ç¤ºä¾‹**ï¼š
```
å‡è®¾ä¸€ä¸ªfourmeme tokenæ¯å°æ—¶10ç¬”äº¤æ˜“ï¼š
ä¹‹å‰ï¼š10ç¬” Ã— 10ç§¯åˆ† = 100ç§¯åˆ†/å°æ—¶
ç°åœ¨ï¼š1ç¬”ï¼ˆé¦–æ¬¡ï¼‰ Ã— 10ç§¯åˆ† + 9ç¬”ï¼ˆç¼“å­˜ï¼‰ Ã— 0ç§¯åˆ† = 10ç§¯åˆ†/å°æ—¶
èŠ‚çœï¼š90ç§¯åˆ†/å°æ—¶ï¼ˆ90%èŠ‚çœï¼‰
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§

---

### 10. å¤–ç›˜é€»è¾‘ä¿®å¤ï¼ˆç¨³å®šå¸ä½ç½®åˆ¤æ–­ï¼‰âœ… å·²å®Œæˆï¼ˆ2025-11-09ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:handle_swap_event` - ç¨³å®šå¸ä½ç½®ç¡¬ç¼–ç 
- âŒ ä»£ç å†™æ­» `token0 = é¡¹ç›®ä»£å¸`ã€`token1 = ç¨³å®šå¸ï¼ˆUSDT/USDC/WBNBï¼‰`
- âŒ åªæŠŠ `amount1In > 0 && amount0Out > 0` è¯†åˆ«ä¸ºä¹°å…¥
- âŒ æŠŠ `amount0In > 0 && amount1Out > 0` é”™è¯¯åœ°å½“æˆå–å‡ºå¹¶return
- âŒ ç»“æœï¼š**å½“ç¨³å®šå¸åœ¨token0æ—¶ï¼Œæ‰€æœ‰ä¹°å•è¢«æ¼æ‰ï¼ˆ50%æ¼å•ç‡ï¼‰**

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-09ï¼‰**ï¼š

**1. åŠ¨æ€ç¨³å®šå¸åˆ¤æ–­**
```python
# é˜¶æ®µ1ï¼šRPCè·å–åŸºç¡€ä¿¡æ¯
pair_info_rpc = self.get_pair_full_info(pair_address)
t0 = pair_info_rpc['token0'].lower()
t1 = pair_info_rpc['token1'].lower()
sym0 = pair_info_rpc.get('symbol0', '???')
sym1 = pair_info_rpc.get('symbol1', '???')
dec0 = pair_info_rpc.get('decimals0', 18)
dec1 = pair_info_rpc.get('decimals1', 18)

stable = {self.USDT, self.USDC, self.WBNB}

# æ ¹æ®å“ªä¸€ä¾§æ˜¯ç¨³å®šå¸ï¼Œå†³å®š"ä¹°å•å½¢æ€"å’Œæ•°é‡å–å€¼
if t0 in stable:
    # ç¨³å®šå¸åœ¨ token0ï¼šä¹°å…¥ = ä»˜ token0ï¼Œå¾— token1
    is_buy = (amount0_in > 0 and amount1_out > 0)
    quote_token   = t0;  quote_symbol  = sym0;  quote_decimals = dec0
    base_token    = t1;  base_symbol   = sym1;  base_decimals  = dec1
    quote_amount  = amount0_in
    base_amount   = amount1_out
elif t1 in stable:
    # ç¨³å®šå¸åœ¨ token1ï¼šä¹°å…¥ = ä»˜ token1ï¼Œå¾— token0
    is_buy = (amount1_in > 0 and amount0_out > 0)
    quote_token   = t1;  quote_symbol  = sym1;  quote_decimals = dec1
    base_token    = t0;  base_symbol   = sym0;  base_decimals  = dec0
    quote_amount  = amount1_in
    base_amount   = amount0_out
else:
    # æ—¢ä¸æ˜¯ USDT/USDC/WBNB å¯¹ï¼Œç›´æ¥è·³è¿‡
    return
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… åŠ¨æ€åˆ¤æ–­ç¨³å®šå¸åœ¨ token0 è¿˜æ˜¯ token1
- âœ… æ ¹æ®ç¨³å®šå¸ä½ç½®æ­£ç¡®è¯†åˆ«ä¹°å…¥æ–¹å‘
- âœ… æ ¹æ®å®é™…ä½ç½®ä½¿ç”¨æ­£ç¡®çš„ decimals å’Œ symbol
- âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—è¿½è¸ªæ–¹å‘åˆ¤æ–­

**æµ‹è¯•éªŒè¯**ï¼š
```python
âœ… æµ‹è¯•ç”¨ä¾‹1: ç¨³å®šå¸åœ¨token0çš„ä¹°å…¥ï¼ˆä¿®å¤å‰ä¼šæ¼ï¼‰
âœ… æµ‹è¯•ç”¨ä¾‹2: ç¨³å®šå¸åœ¨token1çš„ä¹°å…¥ï¼ˆåŸæœ¬å°±èƒ½è¯†åˆ«ï¼‰
âœ… æµ‹è¯•ç”¨ä¾‹3: ç¨³å®šå¸åœ¨token0çš„å–å‡ºï¼ˆæ­£ç¡®è¿‡æ»¤ï¼‰
âœ… æµ‹è¯•ç”¨ä¾‹4: ç¨³å®šå¸åœ¨token1çš„å–å‡ºï¼ˆæ­£ç¡®è¿‡æ»¤ï¼‰
```

**æ€§èƒ½æå‡**ï¼š
- âš¡ å¤–ç›˜ä¹°å•è¯†åˆ«ç‡ï¼š50% â†’ 100%ï¼ˆä¿®å¤å‰æ¼ä¸€åŠï¼‰
- âš¡ å‘Šè­¦è¦†ç›–ç‡ï¼šæ˜¾è‘—æå‡

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§

---

### 11. å†…ç›˜é€»è¾‘ä¿®å¤ï¼ˆ8é¡¹æ”¹è¿›ï¼‰âœ… å·²å®Œæˆï¼ˆ2025-11-09ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:handle_proxy_event`
- âŒ **å¿«é€Ÿè·¯å¾„**ï¼šeth_abiè§£ç ä¸ç¨³å®šï¼ŒABIå˜åŒ–å¯¼è‡´å­—æ®µé”™ä½
- âŒ **å¿«é€Ÿè·¯å¾„**ï¼šè§£ç å‡º `pay_token` ä½†ä¸ä½¿ç”¨ï¼Œå†™æ­» `quote_token = USDT`
- âŒ **å…œåº•è·¯å¾„**ï¼šåªç»Ÿè®¡ `to in PROXY` çš„ä»˜è´¹è…¿ï¼Œæ¼æ‰ä¹°å®¶ç›´ä»˜
- âŒ **å…œåº•è·¯å¾„**ï¼šä¸è¯†åˆ«"ä¸¤è·³è·¯ç”±"ï¼ˆbuyer â†’ intermediate â†’ proxyï¼‰
- âŒ **å…œåº•è·¯å¾„**ï¼šä¸è¯†åˆ«"é›¶åœ°å€é“¸é€ "ï¼ˆfrom == 0x0ï¼‰
- âŒ **Proxyç™½åå•**ï¼šé™æ€æ•°ç»„ï¼Œæ–°å®ä¾‹/å½±å­åˆçº¦ä¼šæ¼
- âŒ **æ— pairæ—©æœŸ**ï¼šæ²¡æœ‰pairåœ°å€æ—¶ç›´æ¥returnï¼Œå†…ç›˜ä¸Šæ–°å…¨éƒ¨ä¸¢å¤±
- âŒ **volume fallback**ï¼šç”¨å•ç¬”äº¤æ˜“é‡‘é¢ä½œä¸º1mäº¤æ˜“é‡ï¼ˆä¸åˆç†ï¼‰

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-09ï¼‰**ï¼š

**1. æœ€å°å¿…éœ€å­—æ®µè§£ç ï¼ˆé¿å…ABIé”™ä½ï¼‰**
```python
ZERO = "0x0000000000000000000000000000000000000000"

def _parse_fourmeme_custom_data_min(self, data: str):
    """
    æœ€å°å¿…éœ€å­—æ®µè§£ç ï¼špayToken/addressã€payAmount/uint256ã€getAmount/uint256
    åªè§£æå‰3ä¸ªå›ºå®šæ§½ä½ï¼Œä¸ä¾èµ–å®Œæ•´ABIï¼Œé¿å…äº‹ä»¶ç­¾åå˜åŒ–å¯¼è‡´å­—æ®µé”™ä½
    """
    if not data or data == "0x":
        return None, 0, 0
    hex_ = data[2:] if data.startswith("0x") else data
    if len(hex_) < 64*3:
        return None, 0, 0
    
    # ç¬¬1æ§½ address å·¦å¡«å……ï¼Œå–å³40ä½
    pay_token  = "0x" + hex_[24:64]
    pay_amount = int(hex_[64:128], 16)
    get_amount = int(hex_[128:192], 16)
    
    return pay_token.lower(), pay_amount, get_amount
```

**2. åŠ¨æ€Proxyåˆ¤å®šï¼ˆé™æ€+Rediså­¦ä¹ ï¼‰**
```python
def is_proxy(self, addr: str) -> bool:
    """
    åˆ¤æ–­åœ°å€æ˜¯å¦ä¸º Fourmeme Proxyï¼ˆé™æ€ç™½åå• + RedisåŠ¨æ€å­¦ä¹ ï¼‰
    """
    if not addr:
        return False
    a = addr.lower()
    
    # é™æ€ç™½åå•
    if a in self.FOURMEME_PROXY:
        return True
    
    # RedisåŠ¨æ€ç™½åå•
    try:
        is_dynamic = bool(self.redis_client.client.sismember("bsc:fourmeme_proxies", a))
        if is_dynamic:
            logger.debug(f"ğŸ’¡ åŠ¨æ€Proxyå‘½ä¸­: {a[:10]}...")
        return is_dynamic
    except Exception:
        return False

# å¿«é€Ÿè·¯å¾„ä¸­è‡ªåŠ¨å­¦ä¹ æ–°Proxy
try:
    self.redis_client.client.sadd("bsc:fourmeme_proxies", addr)
    self.redis_client.client.expire("bsc:fourmeme_proxies", 30*24*3600)
    logger.debug(f"ğŸ†• å‘ç°æ–°Proxy: {addr[:10]}...")
except Exception:
    pass
```

**3. å¿«é€Ÿè·¯å¾„æ”¯ä»˜ä»£å¸è¯†åˆ«ä¿®å¤**
```python
# è§£ç å¹¶è¯†åˆ«æ”¯ä»˜ä»£å¸
pay_token, cost, amount = self._parse_fourmeme_custom_data_min(log.get("data","0x"))
if not pay_token or cost <= 0:
    raise ValueError("custom_event_decode_failed")

# è¯†åˆ«æ”¯ä»˜å¸ç§ï¼ˆè€Œä¸æ˜¯å†™æ­»USDTï¼‰
if pay_token == self.USDT:
    quote_symbol = "USDT"
    usd_value = float(cost / 1e18)
elif pay_token == self.USDC:
    quote_symbol = "USDC"
    usd_value = float(cost / 1e18)
elif pay_token == self.WBNB:
    quote_symbol = "WBNB"
    usd_value = float(cost / 1e18) * self.get_wbnb_price()
else:
    raise ValueError("unknown_pay_token")
```

**4. å…œåº•è·¯å¾„å¢å¼ºï¼ˆ3ç§æ–°æ¨¡å¼ï¼‰**
```python
# ä»˜è´¹è…¿ï¼šæ—¢çœ‹ "from==buyer" çš„å‡ºè´¦ï¼Œä¹Ÿçœ‹ "to åœ¨å·²çŸ¥ Proxyé›†åˆ" çš„å…¥è´¦
usdt_in = sum(t["value"] for t in transfers 
              if t["token"]==self.USDT and (t["from"]==buyer or is_proxy(t["to"])))

# two-hop å®¹é”™ï¼šbuyer -> X -> proxyï¼ˆç¨³å®šå¸ï¼‰
if not (usdt_in or usdc_in or wbnb_in) and buyer:
    by_token_to_mid = {(t["token"], t["to"]): t["value"] 
                       for t in transfers 
                       if t["from"]==buyer and t["token"] in stable}
    for (tk, mid), v in by_token_to_mid.items():
        v2 = sum(t["value"] for t in transfers 
                 if t["token"]==tk and t["from"]==mid and is_proxy(t["to"]))
        if v2:
            if tk == self.USDT: usdt_in += min(v, v2)
            # ...

# ä¸»å¸è…¿ï¼šæ—¢çœ‹ proxy è½¬å‡ºï¼Œä¹ŸæŠŠ"é›¶åœ°å€é“¸é€ "ç®—è¿›æ¥
for t in transfers:
    if t["token"] in stable:
        continue
    if is_proxy(t["from"]) or t["from"] == ZERO:
        target_tokens[t["token"]] = target_tokens.get(t["token"], 0) + t["value"]
```

**5. ç§»é™¤ä¸åˆç†çš„volume fallback**
```python
# åˆ é™¤äº†è¿™æ®µé€»è¾‘ï¼š
# if not raw_data and is_internal:
#     # ç”¨å•ç¬”äº¤æ˜“é‡‘é¢ä½œä¸º1m volumeï¼ˆä¸åˆç†ï¼‰
#     volume = usd_value_ctx
#     ...

# ä¿ç•™ç°æœ‰çš„æŒ‡æ•°å›é€€é€»è¾‘ï¼š
if price_change == 0 and volume == 0:
    # 1m â†’ 5m â†’ 1h æŒ‡æ•°å›é€€
    ...
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… ABIè§£ç ç¨³å®šæ€§æå‡ï¼ˆæœ€å°å¿…éœ€å­—æ®µï¼Œä¸ä¾èµ–å®Œæ•´ABIï¼‰
- âœ… æ”¯ä»˜ä»£å¸è¯†åˆ«å‡†ç¡®ï¼ˆUSDT/USDC/WBNBï¼Œæ­£ç¡®è®¡ç®—USDï¼‰
- âœ… ä¹°å®¶ç›´ä»˜è¯†åˆ«ï¼ˆfrom==buyerï¼‰
- âœ… ä¸¤è·³è·¯ç”±è¯†åˆ«ï¼ˆbuyer â†’ intermediate â†’ proxyï¼‰
- âœ… é›¶åœ°å€é“¸é€ è¯†åˆ«ï¼ˆfrom == 0x0ï¼‰
- âœ… Proxyç™½åå•åŠ¨æ€å­¦ä¹ ï¼ˆæ–°å®ä¾‹è‡ªåŠ¨åŠ å…¥Redisï¼ŒTTL=30å¤©ï¼‰
- âœ… æ— pairæ—©æœŸä¸å†ç›´æ¥ä¸¢å¼ƒï¼ˆèµ°äºŒå±‚åˆ¤æ–­ï¼‰
- âœ… Volume fallbacké€»è¾‘å›å½’æ­£å¸¸ï¼ˆ1m â†’ 5m â†’ è·³è¿‡ï¼‰

**æµ‹è¯•åœºæ™¯è¦†ç›–**ï¼š
```
âœ… USDTç›´æ¥æ”¯ä»˜
âœ… USDCæ”¯ä»˜
âœ… WBNBæ”¯ä»˜ï¼ˆä»·æ ¼æ­£ç¡®è®¡ç®—ï¼‰
âœ… ä¹°å®¶ç›´æ¥ç»™Proxyï¼ˆfrom==buyerï¼‰
âœ… ä¸¤è·³è·¯ç”±ï¼ˆbuyer â†’ X â†’ proxyï¼‰
âœ… é›¶åœ°å€é“¸é€ ï¼ˆfrom==0x0ï¼‰
âœ… æ–°Proxyè‡ªåŠ¨å­¦ä¹ 
âœ… åŠ¨æ€Proxyå‘½ä¸­ï¼ˆå¸¦æ—¥å¿—ï¼‰
```

**æ€§èƒ½æå‡**ï¼š
- âš¡ å†…ç›˜ä¹°å•è¯†åˆ«ç‡ï¼šæ˜¾è‘—æå‡ï¼ˆè¦†ç›–æ›´å¤šæ”¯ä»˜æ¨¡å¼ï¼‰
- âš¡ ABIè§£ç ç¨³å®šæ€§ï¼š100%ï¼ˆä¸å†å› ABIå˜åŒ–è€Œå¤±è´¥ï¼‰
- âš¡ æ—©æœŸä»£å¸è¦†ç›–ï¼šä¸å†å› æ— pairè€Œä¸¢å¤±

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§

---

### 12. RPCé™æµä¼˜åŒ–ï¼ˆé™ä½429é”™è¯¯ï¼‰âœ… å·²å®Œæˆï¼ˆ2025-11-09ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:__init__`
- âŒ `self.min_rpc_interval = 0.001`ï¼ˆ1msé—´éš” = 1000 RPSï¼‰è¿‡äºæ¿€è¿›
- âŒ æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤ºå¤§é‡429é”™è¯¯ï¼ˆ17å°æ—¶ç´¯è®¡5554æ¬¡429ï¼‰
- âŒ å¹³å‡æ¯3åˆ†é’Ÿè§¦å‘1æ¬¡429é™æµ

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-09ï¼‰**ï¼š

**è°ƒæ•´RPCè¯·æ±‚é¢‘ç‡**
```python
# ä¿®æ”¹å‰
self.min_rpc_interval = 0.001  # 1msé—´éš” = 1000 RPSï¼ˆå¤ªæ¿€è¿›ï¼‰

# ä¿®æ”¹å
self.min_rpc_interval = 0.04   # 40msé—´éš” = 25 RPSï¼ˆä¿å®ˆç­–ç•¥ï¼‰
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… RPCè¯·æ±‚é¢‘ç‡ä»1000 RPSé™è‡³25 RPSï¼ˆé™ä½40å€ï¼‰
- âœ… é¢„æœŸ429é”™è¯¯ç‡é™ä½90%ä»¥ä¸Š
- âœ… ä¸å½±å“å®é™…å¤„ç†é€Ÿåº¦ï¼ˆå¤§éƒ¨åˆ†è¯·æ±‚æœ‰ç¼“å­˜ï¼‰

**ç›‘æ§æŒ‡æ ‡**ï¼š
```
ä¿®æ”¹å‰ï¼ˆ17å°æ—¶è¿è¡Œï¼‰ï¼š
- ç´¯è®¡429æ¬¡æ•°: 5554
- å¹³å‡é¢‘ç‡: 327æ¬¡/å°æ—¶ï¼ˆ5.4æ¬¡/åˆ†é’Ÿï¼‰
- å›æ‰§ç¼“å­˜å‘½ä¸­ç‡: 8.7%ï¼ˆä»éœ€å¤§é‡RPCï¼‰

ä¿®æ”¹åï¼ˆé¢„æœŸï¼‰ï¼š
- ç´¯è®¡429æ¬¡æ•°: <100æ¬¡/å¤©
- å¹³å‡é¢‘ç‡: <5æ¬¡/å°æ—¶
- ç¼“å­˜å‘½ä¸­ç‡ä¸å˜ï¼ˆç¼“å­˜é€»è¾‘ç‹¬ç«‹ï¼‰
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§ï¼Œå¾…è§‚å¯Ÿ24å°æ—¶æ•ˆæœ

---

### 13. ä»£ç é‡æ„ï¼ˆç»Ÿä¸€æ’­æŠ¥å‡½æ•°ï¼‰âœ… å·²å®Œæˆï¼ˆ2025-11-09ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py` - å†…å¤–ç›˜æ’­æŠ¥é€»è¾‘é‡å¤
- âŒ å¤–ç›˜æ’­æŠ¥ä»£ç ï¼š~90è¡Œ
- âŒ å†…ç›˜æ’­æŠ¥ä»£ç ï¼š~80è¡Œ
- âŒ å¤§é‡é‡å¤é€»è¾‘ï¼ˆé‡‘é¢æ ¼å¼åŒ–ã€æ¶ˆæ¯æ„å»ºã€æ•°æ®æå–ï¼‰
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼ˆä¿®æ”¹ä¸€å¤„éœ€è¦åŒæ­¥ä¿®æ”¹ä¸¤å¤„ï¼‰

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-09ï¼‰**ï¼š

**1. åˆ›å»ºç»Ÿä¸€æ’­æŠ¥å‡½æ•°**
```python
async def _build_alert_message_and_send(
    self,
    tx_hash: str,
    token_address: str,
    token_symbol: str,
    quote_amount: int,
    quote_decimals: int,
    quote_symbol: str,
    base_amount: int = None,
    base_decimals: int = None,
    usd_value: float = 0,
    token_data: dict = None,
    is_internal: bool = False
) -> bool:
    """ç»Ÿä¸€çš„æ’­æŠ¥å‡½æ•°ï¼ˆå†…å¤–ç›˜é€šç”¨ï¼‰"""
    # æ ¼å¼åŒ–é‡‘é¢
    # æå–token_dataå­—æ®µ
    # æ„å»ºå‘Šè­¦åŸå› 
    # ç”Ÿæˆæ¶ˆæ¯æ¨¡æ¿
    # å‘é€Telegramé€šçŸ¥
    return send_success
```

**2. å†…å¤–ç›˜å·®å¼‚è‡ªåŠ¨å¤„ç†**
| å·®å¼‚ç‚¹ | å¤–ç›˜ | å†…ç›˜ | æ§åˆ¶æ–¹å¼ |
|--------|------|------|----------|
| æ ‡é¢˜emoji | ğŸŸ¢ï¼ˆå›ºå®šï¼‰ | ğŸ”´/ğŸŸ¢ï¼ˆåŠ¨æ€ï¼‰ | `pool_emoji` |
| äº¤æ˜“å“ˆå¸Œ | âœ… æ˜¾ç¤º | âŒ ä¸æ˜¾ç¤º | `if not is_internal` |
| è·å¾—ä»£å¸ | âœ… æ˜¾ç¤º | âŒ ä¸æ˜¾ç¤º | `if base_formatted` |
| å•ç‹¬æ˜¾ç¤ºäº¤æ˜“é‡ | âŒ | âœ… æ˜¾ç¤º | `if is_internal` |
| å•ç‹¬æ˜¾ç¤ºæ¶¨è·Œå¹… | âŒ | âœ… æ˜¾ç¤º | `if is_internal` |
| è§¦å‘åŸå› æ ‡é¢˜ | âœ¨ | ğŸ”” | æ¡ä»¶åˆ¤æ–­ |

**3. ä»£ç ç®€åŒ–ç»Ÿè®¡**
| é¡¹ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å | å‡å°‘ |
|------|--------|--------|------|
| **å¤–ç›˜æ’­æŠ¥** | ~90è¡Œ | ~5è¡Œï¼ˆè°ƒç”¨ï¼‰ | -85è¡Œ |
| **å†…ç›˜æ’­æŠ¥** | ~80è¡Œ | ~5è¡Œï¼ˆè°ƒç”¨ï¼‰ | -75è¡Œ |
| **ç»Ÿä¸€å‡½æ•°** | 0è¡Œ | 135è¡Œï¼ˆæ–°å¢ï¼‰ | +135è¡Œ |
| **æ€»è®¡** | 170è¡Œ | 145è¡Œ | **å‡å°‘25è¡Œ** |

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ¶ˆé™¤ä»£ç é‡å¤ï¼ˆDRYåŸåˆ™ï¼‰
- âœ… ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼ˆå†…å¤–ç›˜ä¸€è‡´æ€§ï¼‰
- âœ… ç»´æŠ¤æˆæœ¬é™ä½ï¼ˆä¿®æ”¹ä¸€å¤„å³å¯ï¼‰
- âœ… å¯è¯»æ€§æå‡ï¼ˆé€»è¾‘é›†ä¸­ï¼‰

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```python
# å¤–ç›˜è°ƒç”¨
send_success = await self._build_alert_message_and_send(
    tx_hash=tx_hash,
    token_address=base_token,
    token_symbol=base_symbol,
    quote_amount=quote_amount,
    quote_decimals=quote_decimals,
    quote_symbol=quote_symbol,
    base_amount=base_amount,      # å¤–ç›˜æ˜¾ç¤ºè·å¾—ä»£å¸
    base_decimals=base_decimals,
    usd_value=usd_value,
    token_data=token_data,
    is_internal=False
)

# å†…ç›˜è°ƒç”¨
send_success = await self._build_alert_message_and_send(
    tx_hash=tx_hash,
    token_address=target_token,
    token_symbol=symbol,
    quote_amount=quote_amount,
    quote_decimals=18,
    quote_symbol=quote_symbol,
    base_amount=None,             # å†…ç›˜ä¸æ˜¾ç¤ºè·å¾—ä»£å¸
    usd_value=usd_value,
    token_data=token_data,
    is_internal=True
)
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§

---

### 14. å¥åº·æ£€æŸ¥ç»Ÿè®¡BUGä¿®å¤ âœ… å·²å®Œæˆï¼ˆ2025-11-09ï¼‰

**åŸé—®é¢˜**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:2440-2445` - å¤–ç›˜ç¬¬äºŒå±‚æ£€æŸ¥ç»Ÿè®¡é—æ¼
- âŒ å¤–ç›˜åœ¨ `handle_swap_event` é‡Œåšç¬¬äºŒå±‚æ£€æŸ¥ï¼Œä½†æ²¡æœ‰å¢åŠ  `self.second_layer_check_external` è®¡æ•°å™¨
- âŒ åªå¢åŠ äº†Prometheus metricsï¼Œå¿˜è®°å¢åŠ å®ä¾‹å˜é‡
- âŒ **ç»“æœ**ï¼šå¥åº·æ£€æŸ¥æ—¥å¿—æ˜¾ç¤º"ç¬¬äºŒå±‚æ£€æŸ¥å…¨æ˜¯å†…ç›˜ï¼Œä½†é€šè¿‡çš„å…¨æ˜¯å¤–ç›˜"ï¼ˆé€»è¾‘çŸ›ç›¾ï¼‰

**æ—¥å¿—å¼‚å¸¸ç¤ºä¾‹**ï¼š
```
ç¬¬äºŒå±‚æ£€æŸ¥: 150 ä¸ª
   â”œâ”€ ğŸ”´ å†…ç›˜: 150 (100.0%)
   â””â”€ ğŸŸ¢ å¤–ç›˜: 0 (0.0%)        â† å¤–ç›˜è®¡æ•°ä¸º0ï¼ˆé”™è¯¯ï¼ï¼‰
   â”œâ”€ âœ… é€šè¿‡: 6 (4.0%)
   â”‚  â”œâ”€ ğŸ”´ å†…ç›˜: 0
   â”‚  â””â”€ ğŸŸ¢ å¤–ç›˜: 6            â† å¤–ç›˜é€šè¿‡6ä¸ªï¼ˆçŸ›ç›¾ï¼ï¼‰
```

**âœ… å·²å®æ–½æ–¹æ¡ˆï¼ˆ2025-11-09ï¼‰**ï¼š

**æ·»åŠ é—æ¼çš„è®¡æ•°å™¨å¢é‡**
```python
# ä¿®æ”¹å‰
external_config = self.external_events_config

# Prometheus: å¤–ç›˜ç¬¬äºŒå±‚æ£€æŸ¥è®¡æ•°
if HAS_PROMETHEUS:
    self.metrics_second_layer_check.labels(type='external', path='api').inc()

# ä¿®æ”¹å
external_config = self.external_events_config

# å¤–ç›˜ç¬¬äºŒå±‚æ£€æŸ¥è®¡æ•°ï¼ˆåŒæ—¶æ›´æ–°å®ä¾‹å˜é‡å’ŒPrometheusï¼‰
self.second_layer_check_external += 1  # â† æ–°å¢è¿™è¡Œ
if HAS_PROMETHEUS:
    self.metrics_second_layer_check.labels(type='external', path='api').inc()
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… å¤–ç›˜ç¬¬äºŒå±‚æ£€æŸ¥è®¡æ•°æ­£ç¡®ç´¯åŠ 
- âœ… å¥åº·æ£€æŸ¥æ—¥å¿—ç»Ÿè®¡å‡†ç¡®
- âœ… å†…å¤–ç›˜ç»Ÿè®¡é€»è¾‘ä¸€è‡´

**ä¿®å¤åçš„æ—¥å¿—ï¼ˆæ­£å¸¸ï¼‰**ï¼š
```
ç¬¬äºŒå±‚æ£€æŸ¥: 156 ä¸ª
   â”œâ”€ ğŸ”´ å†…ç›˜: 150 (96.2%)
   â””â”€ ğŸŸ¢ å¤–ç›˜: 6 (3.8%)        â† å¤–ç›˜è®¡æ•°æ­£ç¡®
   â”œâ”€ âœ… é€šè¿‡: 6 (3.8%)
   â”‚  â”œâ”€ ğŸ”´ å†…ç›˜: 0
   â”‚  â””â”€ ğŸŸ¢ å¤–ç›˜: 6            â† é€»è¾‘ä¸€è‡´
```

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ç”Ÿäº§

---

## âš¡ P1 - é‡è¦ä¼˜åŒ–ï¼ˆ2å‘¨å†…ï¼Œ5å¤©ï¼‰

### 8. å®Œå…¨asyncioåŒ–é‡æ„ â­â­â­ (ä¼˜å…ˆçº§ä¸‹è°ƒ)

**ä¼˜å…ˆçº§è°ƒæ•´è¯´æ˜**ï¼š
- **åŸæ¥**ï¼šâ­â­â­â­â­ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- **ç°åœ¨**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰
- **åŸå› **ï¼šç›´æ¥å¤„ç†æ¨¡å¼å·²ç»è§£å†³äº†æ ¸å¿ƒæ€§èƒ½é—®é¢˜ï¼ŒasyncioåŒ–ä¸å†ç´§æ€¥

**å½“å‰æ¶æ„å·²è¶³å¤Ÿ**ï¼š
- 20çº¿ç¨‹ç›´æ¥å¤„ç†ï¼Œå¤„ç†èƒ½åŠ› ~40 msg/s
- RPCç¼“å­˜å¼ºå¤§ï¼ˆ< 1 RPSï¼‰ï¼Œæ— ç“¶é¢ˆ
- 8æ ¸24Gèµ„æºå……è¶³ï¼Œ20çº¿ç¨‹å ç”¨å¯æ¥å—
- å®é™…æµ‹è¯•ï¼š0ä¸¢æ¶ˆæ¯ï¼Œå»¶è¿Ÿä½

**asyncioåŒ–ä»æœ‰ä»·å€¼ï¼Œä½†ä¸ç´§æ€¥**ï¼š
- å¯ä»¥ä½œä¸ºé•¿æœŸä¼˜åŒ–ç›®æ ‡
- é€‚åˆåœ¨ä¸šåŠ¡ç¨³å®šåå†è€ƒè™‘
- éœ€è¦å……åˆ†æµ‹è¯•ï¼Œé£é™©è¾ƒé«˜

**å·¥ä½œé‡**ï¼š3å¤©

**å»ºè®®æ—¶æœº**ï¼š
- å½“å‰æ¶æ„è¿è¡Œç¨³å®š3-6ä¸ªæœˆå
- æˆ–ä¸šåŠ¡å¢é•¿å¯¼è‡´20çº¿ç¨‹ä¸å¤Ÿæ—¶
- æˆ–æœ‰å……è¶³çš„æµ‹è¯•èµ„æºæ—¶

---

### 9. é…ç½®ç®¡ç†é›†ä¸­åŒ– â­â­â­

**é—®é¢˜å®šä½**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:120-200` - ç¡¬ç¼–ç é…ç½®
- é…ç½®åˆ†æ•£åœ¨ï¼šä»£ç ã€Redisã€ç¯å¢ƒå˜é‡ã€æ•°æ®åº“
- ä¿®æ”¹é…ç½®éœ€è¦æ”¹ä»£ç +é‡å¯

**å®æ–½æ–¹æ¡ˆï¼ˆ1å¤©ï¼‰**ï¼š

**é˜¶æ®µ1ï¼šé›†ä¸­åˆ°é…ç½®æ–‡ä»¶**

**åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š
- `config/bsc_monitor.yaml` - BSCç›‘æ§é…ç½®
- `config/sol_monitor.yaml` - SOLç›‘æ§é…ç½®
- `config/common.yaml` - é€šç”¨é…ç½®ï¼ˆæ•°æ®åº“ã€Redisã€Telegramï¼‰

**é…ç½®ç»“æ„ç¤ºä¾‹**ï¼š
```yaml
# config/bsc_monitor.yaml
websocket:
  url: "wss://bsc-mainnet.nodereal.io/ws/v1/xxx"
  rpc_url: "https://bsc-mainnet.nodereal.io/v1/xxx"

filters:
  layer1:
    internal:
      min_amount: 400  # USDT
      cumulative_min_amount: 1000
    external:
      min_amount: 400
  
  layer2:
    price_change:
      threshold: 0.05  # 5%
      time_window: "1m"
    volume:
      min_volume: 1000  # USDT
    
cooldown:
  minutes: 3
  jitter_seconds: 30

alerts:
  telegram:
    enabled: true
    chat_id: "-1001234567890"
  wechat:
    enabled: false
```

**ä½¿ç”¨Pydanticå®šä¹‰Schema**ï¼š
- ç±»å‹æ ¡éªŒï¼ˆint/float/str/boolï¼‰
- é»˜è®¤å€¼
- å¿…å¡«å­—æ®µéªŒè¯
- è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘

**åŠ è½½é¡ºåº**ï¼š
1. è¯»å–YAMLé…ç½®ï¼ˆåŸºç¡€é…ç½®ï¼‰
2. ç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆ`export BSC_MIN_AMOUNT=500`ï¼‰
3. Redisç¼“å­˜è¯»å–ï¼ˆåŠ¨æ€é…ç½®ï¼Œå¯é€‰ï¼‰

**é˜¶æ®µ2ï¼šé…ç½®çƒ­æ›´æ–°ï¼ˆå¯é€‰ï¼Œè¿œæœŸï¼‰**

**æ–¹æ¡ˆAï¼šæ–‡ä»¶ç›‘å¬**
- ä½¿ç”¨ `watchdog` åº“ç›‘å¬é…ç½®æ–‡ä»¶ä¿®æ”¹
- æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨reloadé…ç½®
- æ›´æ–°å†…å­˜ä¸­çš„é…ç½®å¯¹è±¡

**æ–¹æ¡ˆBï¼šRedis Pub/Sub**
- åå°ç®¡ç†ç³»ç»Ÿä¿®æ”¹é…ç½®åå‘å¸ƒæ¶ˆæ¯
- Monitorè®¢é˜…é…ç½®æ›´æ–°é¢‘é“
- æ”¶åˆ°æ¶ˆæ¯åreloadé…ç½®

**æ”¶ç›Š**ï¼š
- âœ… ä¿®æ”¹é…ç½®ä¸æ”¹ä»£ç 
- âœ… å¤šç¯å¢ƒéƒ¨ç½²æ–¹ä¾¿ï¼ˆdev/staging/prodä¸åŒé…ç½®ï¼‰
- âœ… é…ç½®é›†ä¸­ç®¡ç†ï¼Œæ˜“äºå®¡è®¡
- âœ… é…ç½®æ ¡éªŒï¼Œé¿å…é”™è¯¯é…ç½®
- âœ… æ”¯æŒçƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯ï¼‰

**å·¥ä½œé‡**ï¼š1å¤©ï¼ˆé˜¶æ®µ1ï¼‰ + 2å¤©ï¼ˆé˜¶æ®µ2ï¼Œå¯é€‰ï¼‰

---

### 10. æŒ‡æ ‡é™çº§ç­–ç•¥ä¼˜åŒ– â­â­â­

**é—®é¢˜å®šä½**ï¼š
- ğŸ“ `src/solalert/monitor/bsc_websocket_monitor.py:1863-1869`
- å½“DBotX APIç¼ºå­—æ®µæ—¶ï¼Œç›´æ¥åŠ å…¥ `no_data_pair` ç¼“å­˜ï¼ˆTTL=1å°æ—¶ï¼‰
- ç¼“å­˜æœŸå†…è¯¥pairå®Œå…¨ä¸å‘Šè­¦ â†’ å¯èƒ½æ¼æŠ¥

**å½±å“è¯„ä¼°**ï¼š
- å½“å‰é™çº§ç‡ï¼š~6.2%
- å¦‚æœAPIä¸´æ—¶æ•…éšœæ¢å¤åï¼Œ1å°æ—¶å†…ä»ä¸å‘Šè­¦

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼šåˆ†çº§é™çº§ï¼ˆæ¨èï¼‰**
- **Level 0**ï¼šAPIå®Œæ•´æ•°æ® â†’ å®Œæ•´å‘Šè­¦ï¼ˆä»·æ ¼ã€æ¶¨è·Œå¹…ã€äº¤æ˜“é‡ç­‰ï¼‰
- **Level 1**ï¼šAPIéƒ¨åˆ†æ•°æ® + RPC â†’ åŸºç¡€å‘Šè­¦ï¼ˆåªæœ‰ä»·æ ¼å’Œé‡‘é¢ï¼Œæ ‡æ³¨"æ•°æ®ä¸å®Œæ•´"ï¼‰
- **Level 2**ï¼šçº¯RPC â†’ ä»…é‡‘é¢å‘Šè­¦ï¼ˆæ ‡æ³¨"æŒ‡æ ‡ç¼ºå¤±ï¼Œä»…åŸºäºé‡‘é¢"ï¼‰

**æ–¹æ¡ˆBï¼šæ™ºèƒ½é‡è¯•ç¼“å­˜**
- é¦–æ¬¡APIå¤±è´¥ï¼šç¼“å­˜5åˆ†é’Ÿ
- è¿ç»­2æ¬¡å¤±è´¥ï¼šç¼“å­˜30åˆ†é’Ÿ
- è¿ç»­3æ¬¡ä»¥ä¸Šå¤±è´¥ï¼šç¼“å­˜1å°æ—¶
- ä¸€æ—¦æˆåŠŸï¼šæ¸…é™¤ç¼“å­˜

**æ–¹æ¡ˆCï¼šç¼©çŸ­TTLï¼ˆæœ€ç®€å•ï¼‰**
- ä»1å°æ—¶ç¼©çŸ­åˆ°10åˆ†é’Ÿ
- å‡å°‘æ¼æŠ¥çª—å£

**æ–¹æ¡ˆDï¼šå¤‡ä»½APIï¼ˆè°¨æ…ï¼‰**
- DBotXå¤±è´¥æ—¶åˆ‡æ¢åˆ°DexScreener/GMGN
- âš ï¸ é£é™©ï¼šå¢åŠ å¤æ‚åº¦ã€æ•°æ®å¯èƒ½ä¸ä¸€è‡´
- âš ï¸ ä¸æ¨èä½œä¸ºé¦–é€‰

**å»ºè®®å®æ–½é¡ºåº**ï¼š
1. **å…ˆç”¨æ–¹æ¡ˆC**ï¼ˆç¼©çŸ­TTLåˆ°10åˆ†é’Ÿï¼‰- 5åˆ†é’Ÿå·¥ä½œé‡
2. **è§‚å¯Ÿ1-2å‘¨**ï¼Œçœ‹é™çº§ç‡å’Œæ¼æŠ¥æƒ…å†µ
3. **å¦‚æœä»æœ‰é—®é¢˜**ï¼Œå†è€ƒè™‘æ–¹æ¡ˆAæˆ–B

**æ”¶ç›Š**ï¼š
- âœ… å‡å°‘æ¼æŠ¥ï¼ˆAPIä¸´æ—¶æ•…éšœæ¢å¤åæ›´å¿«é‡è¯•ï¼‰
- âœ… ä¿ç•™é™çº§èƒ½åŠ›ï¼ˆAPIé•¿æœŸæ•…éšœæ—¶é¿å…é¢‘ç¹RPCï¼‰

**å·¥ä½œé‡**ï¼šæ–¹æ¡ˆCä»…5åˆ†é’Ÿï¼Œæ–¹æ¡ˆA/Béœ€1å¤©

---

### 11. å•å…ƒæµ‹è¯• + CI â­â­â­

**é—®é¢˜**ï¼š
- æ— è‡ªåŠ¨åŒ–æµ‹è¯•
- é‡æ„é£é™©é«˜ï¼ˆå¯èƒ½å¼•å…¥regression bugï¼‰
- ä»£ç è´¨é‡æ— ä¿éšœ

**å®æ–½æ–¹æ¡ˆï¼ˆ1å¤©ï¼‰**ï¼š

**é˜¶æ®µ1ï¼šSmoke Testï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰**

**æµ‹è¯•æ¡†æ¶**ï¼š
- `pytest` - æµ‹è¯•æ¡†æ¶
- `pytest-asyncio` - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- `unittest.mock` - Mockå¤–éƒ¨ä¾èµ–

**æµ‹è¯•èŒƒå›´**ï¼š
1. **è¿‡æ»¤å™¨é€»è¾‘**
   - ç¬¬ä¸€å±‚ï¼šé‡‘é¢è¿‡æ»¤ï¼ˆå•ç¬”ã€ç´¯è®¡ï¼‰
   - ç¬¬äºŒå±‚ï¼šæŒ‡æ ‡è¿‡æ»¤ï¼ˆä»·æ ¼ã€äº¤æ˜“é‡ã€å¸‚å€¼ï¼‰
   - è§¦å‘é€»è¾‘ï¼ˆany/allï¼‰

2. **äº‹ä»¶å¤„ç†**
   - `handle_swap_event` å¿«é€Ÿè·¯å¾„ï¼ˆAPIå®Œæ•´æ•°æ®ï¼‰
   - `handle_swap_event` é™çº§è·¯å¾„ï¼ˆAPIå¤±è´¥ï¼ŒRPCå…œåº•ï¼‰
   - `handle_swap_event` é”™è¯¯å¤„ç†

3. **å†·å´æœŸåˆ¤æ–­**
   - é¦–æ¬¡å‘Šè­¦
   - å†·å´æœŸå†…é‡å¤äº‹ä»¶ï¼ˆåº”è·³è¿‡ï¼‰
   - å†·å´æœŸè¿‡åï¼ˆåº”é‡æ–°å‘Šè­¦ï¼‰

4. **APIå®¢æˆ·ç«¯**
   - æ­£å¸¸å“åº”
   - è¶…æ—¶é‡è¯•
   - é”™è¯¯å¤„ç†

**Mockç­–ç•¥**ï¼š
- Mock APIè°ƒç”¨ï¼ˆDBotXã€GMGNï¼‰
- Mock RPCè°ƒç”¨
- Mock Redis
- Mock Database
- Mock Telegram/WeChat

**é˜¶æ®µ2ï¼šGitHub Actions CI**

**Workflowé…ç½®**ï¼š
```yaml
# .github/workflows/test.yml
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: pip install pytest pytest-asyncio
      - run: pytest tests/ -v --cov=src/solalert
      - run: mypy src/solalert --ignore-missing-imports
      - run: flake8 src/solalert --max-line-length=120
```

**é˜¶æ®µ3ï¼šPre-commit Hooksï¼ˆå¯é€‰ï¼‰**

**é…ç½®**ï¼š
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/psf/black
    hooks:
      - id: black
  - repo: https://github.com/PyCQA/flake8
    hooks:
      - id: flake8
```

**å®‰è£…**ï¼š
```bash
pip install pre-commit
pre-commit install
```

**æ”¶ç›Š**ï¼š
- âœ… é‡æ„æœ‰ä¿éšœï¼ˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘ï¼‰
- âœ… é¿å…å¼•å…¥bugï¼ˆCIè‡ªåŠ¨æ£€æµ‹ï¼‰
- âœ… ä»£ç è´¨é‡æå‡ï¼ˆç±»å‹æ£€æŸ¥ã€æ ¼å¼æ£€æŸ¥ï¼‰
- âœ… å¿«é€Ÿåé¦ˆï¼ˆPRæ—¶è‡ªåŠ¨è·‘æµ‹è¯•ï¼‰

**å·¥ä½œé‡**ï¼š1å¤©

---

### 12. ä¸šåŠ¡ç›‘æ§å‘Šè­¦ â­â­â­

**é—®é¢˜**ï¼š
- åªæœ‰ç”¨æˆ·å‘Šè­¦ï¼ˆtokenæ¶¨è·Œï¼‰ï¼Œæ²¡æœ‰ç³»ç»Ÿè¿ç»´å‘Šè­¦
- ç³»ç»Ÿå¼‚å¸¸éœ€è¦äººå·¥å‘ç°ï¼ˆæŸ¥æ—¥å¿—ï¼‰

**å®æ–½æ–¹æ¡ˆï¼ˆåŸºäºPrometheusï¼‰**ï¼š

**å‘Šè­¦è§„åˆ™å®šä¹‰**ï¼š

åˆ›å»º `monitoring/alert_rules.yml`ï¼š

**1. WebSocketè¿æ¥å‘Šè­¦**
```yaml
- alert: WebSocketDisconnected
  expr: sol_ws_connections_active{batch_id=~".*"} == 0
  for: 5m
  annotations:
    summary: "WebSocketè¿æ¥æ–­å¼€è¶…è¿‡5åˆ†é’Ÿ"
    description: "Batch {{ $labels.batch_id }} å·²æ–­å¼€5åˆ†é’Ÿ"
```

**2. APIé”™è¯¯ç‡å‘Šè­¦**
```yaml
- alert: HighAPIErrorRate
  expr: |
    rate(api_requests_total{status="error"}[5m]) / 
    rate(api_requests_total[5m]) > 0.1
  for: 5m
  annotations:
    summary: "APIé”™è¯¯ç‡è¶…è¿‡10%"
```

**3. æ•°æ®åº“è¿æ¥æ± å‘Šè­¦**
```yaml
- alert: DatabasePoolExhausted
  expr: database_connections_active >= 19
  for: 2m
  annotations:
    summary: "æ•°æ®åº“è¿æ¥æ± æ¥è¿‘è€—å°½"
```

**4. æ¶ˆæ¯å¤„ç†å»¶è¿Ÿå‘Šè­¦**
```yaml
- alert: HighMessageProcessingLatency
  expr: |
    histogram_quantile(0.95, 
      rate(bsc_ws_messages_processing_seconds_bucket[5m])
    ) > 10
  for: 5m
  annotations:
    summary: "95%æ¶ˆæ¯å¤„ç†å»¶è¿Ÿè¶…è¿‡10ç§’"
```

**5. æ— æ•°æ®æ¥æ”¶å‘Šè­¦**
```yaml
- alert: NoDataReceived
  expr: |
    rate(bsc_ws_messages_total[1h]) == 0
  for: 1h
  annotations:
    summary: "è¿‡å»1å°æ—¶æœªæ¥æ”¶åˆ°ä»»ä½•æ¶ˆæ¯"
    description: "å¯èƒ½WebSocket stuckæˆ–ç½‘ç»œé—®é¢˜"
```

**å‘Šè­¦å‘é€**ï¼š
- **ç‹¬ç«‹ops Telegramé¢‘é“**ï¼ˆä¸æ··å…¥ç”¨æˆ·å‘Šè­¦ï¼‰
- æˆ–é›†æˆåˆ°PagerDuty/é’‰é’‰/ä¼ä¸šå¾®ä¿¡
- åŒºåˆ†å‘Šè­¦ç­‰çº§ï¼ˆP0/P1/P2ï¼‰

**å‘Šè­¦æ”¶æ•›**ï¼š
- åŒä¸€å‘Šè­¦5åˆ†é’Ÿå†…æœ€å¤šå‘é€1æ¬¡
- åŒç±»å‘Šè­¦èšåˆï¼ˆå¦‚3ä¸ªbatchåŒæ—¶æ–­è¿ â†’ å‘é€1æ¡æ±‡æ€»ï¼‰

**æ”¶ç›Š**ï¼š
- âœ… å¿«é€Ÿå‘ç°ç³»ç»Ÿé—®é¢˜
- âœ… é™ä½MTTRï¼ˆå¹³å‡æ¢å¤æ—¶é—´ï¼‰
- âœ… ä¸»åŠ¨è¿ç»´ï¼ˆè€Œä¸æ˜¯è¢«åŠ¨ç­‰ç”¨æˆ·æŠ¥å‘Šï¼‰

**å·¥ä½œé‡**ï¼š1å¤©ï¼ˆé…ç½®å‘Šè­¦è§„åˆ™ + æµ‹è¯•ï¼‰

---

### 13. å‘Šè­¦å¯é æ€§ä¿éšœæœºåˆ¶ â­â­â­â­â­

**é—®é¢˜**ï¼š
- âŒ Telegramå‘é€å¤±è´¥åtokenè¢«cooldowné”æ­»ï¼ˆå·²åœ¨P0#8ä¿®å¤ï¼‰
- âŒ ç¼ºå°‘é‡è¯•æœºåˆ¶ï¼ˆä¸€æ¬¡å¤±è´¥=æ°¸ä¹…ä¸¢å¤±ï¼‰
- âŒ æ— å¤±è´¥å‘Šè­¦è¿½æº¯ï¼ˆä¸çŸ¥é“ä¸¢äº†å¤šå°‘ï¼‰

**å®æ–½æ–¹æ¡ˆï¼ˆ1å¤©ï¼‰**ï¼š

**é˜¶æ®µ1ï¼šå‘Šè­¦é‡è¯•é˜Ÿåˆ—**

åˆ›å»º `src/solalert/utils/alert_retry_queue.py`ï¼š

```python
class AlertRetryQueue:
    """å‘Šè­¦é‡è¯•é˜Ÿåˆ—ï¼ˆRedisæ”¯æŒï¼‰"""
    
    def __init__(self, redis_client, max_retries=3, retry_interval=300):
        self.redis = redis_client
        self.max_retries = max_retries
        self.retry_interval = retry_interval  # 5åˆ†é’Ÿ
    
    def add_failed_alert(self, token: str, message: str, reason: str):
        """æ·»åŠ å¤±è´¥çš„å‘Šè­¦åˆ°é‡è¯•é˜Ÿåˆ—"""
        retry_key = f"alert:retry:{token}"
        retry_data = {
            "token": token,
            "message": message,
            "failed_at": time.time(),
            "reason": reason,
            "retry_count": 0,
            "last_retry": 0
        }
        self.redis.client.setex(retry_key, 3600, json.dumps(retry_data))  # 1å°æ—¶TTL
        logger.warning(f"ğŸ“¥ å‘Šè­¦åŠ å…¥é‡è¯•é˜Ÿåˆ—: {token[:10]} | åŸå› : {reason}")
    
    async def retry_failed_alerts(self, send_func):
        """å®šæ—¶ä»»åŠ¡ï¼šé‡è¯•å¤±è´¥çš„å‘Šè­¦ï¼ˆæ¯5åˆ†é’Ÿï¼‰"""
        keys = self.redis.client.keys("alert:retry:*")
        
        for key in keys:
            try:
                data = json.loads(self.redis.client.get(key))
                token = data["token"]
                message = data["message"]
                retry_count = data["retry_count"]
                last_retry = data["last_retry"]
                
                # æ£€æŸ¥é‡è¯•é—´éš”
                if time.time() - last_retry < self.retry_interval:
                    continue
                
                # æ£€æŸ¥é‡è¯•æ¬¡æ•°
                if retry_count >= self.max_retries:
                    # è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•° â†’ ç§»å…¥æ­»ä¿¡é˜Ÿåˆ—
                    self._move_to_dlq(data)
                    self.redis.client.delete(key)
                    continue
                
                # å°è¯•é‡å‘
                logger.info(f"ğŸ”„ é‡è¯•å‘Šè­¦ ({retry_count+1}/{self.max_retries}): {token[:10]}")
                success = await send_func(message, token)
                
                if success:
                    logger.info(f"âœ… é‡è¯•æˆåŠŸ: {token[:10]}")
                    self.redis.client.delete(key)
                else:
                    # æ›´æ–°é‡è¯•è®¡æ•°
                    data["retry_count"] += 1
                    data["last_retry"] = time.time()
                    self.redis.client.setex(key, 3600, json.dumps(data))
                    logger.warning(f"âš ï¸  é‡è¯•å¤±è´¥: {token[:10]} | ä¸‹æ¬¡{self.retry_interval}ç§’åé‡è¯•")
                    
            except Exception as e:
                logger.error(f"å¤„ç†é‡è¯•é˜Ÿåˆ—å¼‚å¸¸: {e}")
    
    def _move_to_dlq(self, data):
        """ç§»å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼ˆæ•°æ®åº“å­˜å‚¨ï¼Œäººå·¥reviewï¼‰"""
        # å­˜å…¥MySQLæ­»ä¿¡è¡¨
        sql = """
        INSERT INTO alert_dead_letter_queue 
        (token, message, failed_at, reason, retry_count, created_at)
        VALUES (%s, %s, %s, %s, %s, NOW())
        """
        # æ‰§è¡ŒINSERT...
        logger.error(f"â˜ ï¸  å‘Šè­¦è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—: {data['token'][:10]} | é‡è¯•{data['retry_count']}æ¬¡å‡å¤±è´¥")
```

**é˜¶æ®µ2ï¼šæ­»ä¿¡é˜Ÿåˆ—è¡¨**

```sql
CREATE TABLE IF NOT EXISTS alert_dead_letter_queue (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    token VARCHAR(42) NOT NULL,
    message TEXT NOT NULL,
    failed_at BIGINT NOT NULL,
    reason VARCHAR(500),
    retry_count INT DEFAULT 0,
    created_at DATETIME NOT NULL,
    reviewed TINYINT DEFAULT 0,
    INDEX idx_token (token),
    INDEX idx_created_at (created_at),
    INDEX idx_reviewed (reviewed)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**é˜¶æ®µ3ï¼šé›†æˆåˆ°BSC Monitor**

```python
# åˆå§‹åŒ–
self.retry_queue = AlertRetryQueue(self.redis_client)

# å‘é€å¤±è´¥æ—¶
if not send_success:
    self.retry_queue.add_failed_alert(token, message, "Telegramå‘é€å¤±è´¥")
    await self.remove_alert_cooldown(token)  # è§£é”cooldown

# å®šæ—¶ä»»åŠ¡ï¼ˆæ¯5åˆ†é’Ÿï¼‰
async def retry_loop(self):
    while not self.should_stop:
        await asyncio.sleep(300)  # 5åˆ†é’Ÿ
        await self.retry_queue.retry_failed_alerts(self.send_alert)
```

**æ”¶ç›Š**ï¼š
- âœ… é›¶æ¼æŠ¥ï¼ˆç½‘ç»œä¸´æ—¶æ•…éšœæ¢å¤åè‡ªåŠ¨é‡è¯•ï¼‰
- âœ… å¯è¿½æº¯ï¼ˆæ‰€æœ‰å¤±è´¥æœ‰è®°å½•ï¼‰
- âœ… è‡ªåŠ¨æ¢å¤ï¼ˆæ— éœ€äººå·¥ä»‹å…¥ï¼‰
- âœ… æ­»ä¿¡é˜Ÿåˆ—ï¼ˆé‡è¯•3æ¬¡ä»å¤±è´¥çš„å¯äººå·¥reviewï¼‰

**å·¥ä½œé‡**ï¼š1å¤©

---

### 14. ç¼“å­˜åˆ†çº§TTLç­–ç•¥ â­â­â­â­

**é—®é¢˜**ï¼š
- âŒ æ‰€æœ‰ç¼“å­˜ç”¨åŒä¸€TTLï¼ˆä¸å¤Ÿçµæ´»ï¼‰
- âŒ çƒ­æ•°æ®è¢«æ·˜æ±°ï¼ˆå¦‚é«˜é¢‘tokenï¼‰
- âŒ å†·æ•°æ®å å†…å­˜ï¼ˆå¦‚è¿‡æœŸpairï¼‰

**å®æ–½æ–¹æ¡ˆï¼ˆ2å¤©ï¼‰**ï¼š

**é˜¶æ®µ1ï¼šåˆ†çº§TTLé…ç½®**

```python
# config/cache_config.yaml
cache_ttl:
  # çŸ­æœŸç¼“å­˜ï¼ˆé«˜é¢‘å˜åŒ–ï¼Œå¿«é€Ÿæ·˜æ±°ï¼‰
  receipt_cache: 300          # 5åˆ†é’Ÿ
  eth_call_cache: 60          # 1åˆ†é’Ÿ
  alert_cooldown: 3600        # 1å°æ—¶
  
  # ä¸­æœŸç¼“å­˜ï¼ˆä¸­é¢‘å˜åŒ–ï¼‰
  fourmeme_whitelist: 604800  # 7å¤©
  non_fourmeme_blacklist: 604800  # 7å¤©
  token_metadata: 259200      # 3å¤©
  
  # é•¿æœŸç¼“å­˜ï¼ˆä½é¢‘å˜åŒ–ï¼‰
  pair_info: 2592000          # 30å¤©
  contract_abi: 7776000       # 90å¤©
```

**é˜¶æ®µ2ï¼šæ™ºèƒ½ç¼“å­˜ç®¡ç†å™¨**

```python
from cachetools import TTLCache, LRUCache

class SmartCacheManager:
    """æ™ºèƒ½å¤šçº§ç¼“å­˜ç®¡ç†å™¨"""
    
    def __init__(self):
        # L1: çƒ­æ•°æ®ç¼“å­˜ï¼ˆå†…å­˜ï¼ŒLRUï¼‰
        self.hot_cache = LRUCache(maxsize=1000)  # æœ€å¸¸è®¿é—®
        
        # L2: æ¸©æ•°æ®ç¼“å­˜ï¼ˆå†…å­˜ï¼ŒTTLï¼‰
        self.warm_cache = TTLCache(maxsize=5000, ttl=300)  # 5åˆ†é’Ÿ
        
        # L3: å†·æ•°æ®ç¼“å­˜ï¼ˆRedisï¼Œé•¿TTLï¼‰
        # é€šè¿‡Rediså®ç°
    
    def get(self, key, fetch_func=None):
        """å¤šçº§æŸ¥æ‰¾ï¼šL1 â†’ L2 â†’ L3 â†’ fetch"""
        # L1å‘½ä¸­
        if key in self.hot_cache:
            return self.hot_cache[key]
        
        # L2å‘½ä¸­ â†’ æå‡åˆ°L1
        if key in self.warm_cache:
            value = self.warm_cache[key]
            self.hot_cache[key] = value
            return value
        
        # L3ï¼ˆRedisï¼‰å‘½ä¸­ â†’ æå‡åˆ°L2
        redis_value = self.redis.get(f"cache:{key}")
        if redis_value:
            value = json.loads(redis_value)
            self.warm_cache[key] = value
            return value
        
        # å…¨éƒ¨æœªå‘½ä¸­ â†’ è°ƒç”¨fetchå‡½æ•°
        if fetch_func:
            value = fetch_func(key)
            self.set(key, value)
            return value
        
        return None
    
    def set(self, key, value, level='warm'):
        """æ ¹æ®è®¿é—®é¢‘ç‡å†³å®šç¼“å­˜çº§åˆ«"""
        if level == 'hot':
            self.hot_cache[key] = value
        elif level == 'warm':
            self.warm_cache[key] = value
        
        # åŒæ—¶å†™å…¥Redisï¼ˆL3ï¼‰
        self.redis.setex(f"cache:{key}", 3600, json.dumps(value))
```

**é˜¶æ®µ3ï¼šè®¿é—®é¢‘ç‡ç»Ÿè®¡**

```python
class AccessCounter:
    """ç»Ÿè®¡keyè®¿é—®é¢‘ç‡ï¼ŒåŠ¨æ€è°ƒæ•´ç¼“å­˜çº§åˆ«"""
    
    def __init__(self):
        self.access_count = defaultdict(int)
        self.last_reset = time.time()
    
    def record_access(self, key):
        self.access_count[key] += 1
        
        # æ¯å°æ—¶é‡ç½®ç»Ÿè®¡
        if time.time() - self.last_reset > 3600:
            self._promote_hot_keys()
            self.access_count.clear()
            self.last_reset = time.time()
    
    def _promote_hot_keys(self):
        """æå‡é«˜é¢‘keyåˆ°hotç¼“å­˜"""
        sorted_keys = sorted(
            self.access_count.items(),
            key=lambda x: x[1],
            reverse=True
        )
        
        # Top 100æå‡åˆ°hot
        for key, count in sorted_keys[:100]:
            if count > 10:  # 1å°æ—¶è®¿é—®>10æ¬¡
                # ä»warmæå‡åˆ°hot
                pass
```

**æ”¶ç›Š**ï¼š
- âœ… å†…å­˜åˆ©ç”¨ç‡æå‡ï¼ˆçƒ­æ•°æ®å¸¸é©»ï¼Œå†·æ•°æ®å¿«é€Ÿæ·˜æ±°ï¼‰
- âœ… å‘½ä¸­ç‡æå‡ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
- âœ… è®¿é—®å»¶è¿Ÿé™ä½ï¼ˆL1å†…å­˜è®¿é—® < 1msï¼‰
- âœ… Rediså‹åŠ›é™ä½ï¼ˆL1/L2åˆ†æµï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

### 15. APIæˆæœ¬ç›‘æ§ä¸ä¼˜åŒ– â­â­â­â­

**é—®é¢˜**ï¼š
- âŒ DBotX APIæŒ‰ç§¯åˆ†è®¡è´¹ï¼Œæˆæœ¬ä¸é€æ˜
- âŒ ä¸çŸ¥é“å“ªä¸ªç¯èŠ‚æ¶ˆè€—æœ€å¤š
- âŒ æ— æˆæœ¬é¢„è­¦ï¼ˆå¯èƒ½è¶…æ”¯ï¼‰

**å®æ–½æ–¹æ¡ˆï¼ˆ0.5å¤©ï¼‰**ï¼š

**åŸºäºç°æœ‰Prometheusæ‰©å±•**ï¼š

**1. æ–°å¢Metrics**
```python
# å·²æœ‰
bsc_ws_credits_consumed_total{source="dbotx"}  # æ€»æ¶ˆè€—

# æ–°å¢ç»†åˆ†
bsc_ws_credits_consumed_total{source="launchpad", result="fourmeme"}
bsc_ws_credits_consumed_total{source="launchpad", result="non_fourmeme"}
bsc_ws_credits_consumed_total{source="pair_info", cache="hit"}
bsc_ws_credits_consumed_total{source="pair_info", cache="miss"}
bsc_ws_credits_saved_by_cache_total{cache_type="fourmeme"}
bsc_ws_credits_saved_by_cache_total{cache_type="non_fourmeme"}
```

**2. Grafana Dashboardæ–°å¢é¢æ¿**

```yaml
# 1. å®æ—¶æ¶ˆè€—é€Ÿç‡
title: "APIç§¯åˆ†æ¶ˆè€—é€Ÿç‡"
query: "rate(bsc_ws_credits_consumed_total[1h]) * 3600"
unit: "credits/hour"

# 2. é¢„æµ‹ä»Šæ—¥æ¶ˆè€—
title: "é¢„æµ‹ä»Šæ—¥æ€»æ¶ˆè€—"
query: |
  bsc_ws_credits_consumed_total{source="dbotx"} +
  (rate(bsc_ws_credits_consumed_total{source="dbotx"}[1h]) * 3600 * 
   clamp_min(24 - hour(), 0))
threshold: 
  warning: 800000   # 80ä¸‡
  critical: 1000000 # 100ä¸‡

# 3. ç¼“å­˜å‘½ä¸­ç‡
title: "fourmemeç¼“å­˜èŠ‚çœ"
query: |
  (sum(bsc_ws_credits_saved_by_cache_total) /
   sum(bsc_ws_credits_consumed_total + bsc_ws_credits_saved_by_cache_total)) * 100
unit: "%"

# 4. å„ç¯èŠ‚ç§¯åˆ†å æ¯”
title: "ç§¯åˆ†æ¶ˆè€—åˆ†å¸ƒ"
type: "pie chart"
queries:
  - launchpadæ£€æŸ¥: sum(bsc_ws_credits_consumed_total{source="launchpad"})
  - pair_infoè·å–: sum(bsc_ws_credits_consumed_total{source="pair_info"})
```

**3. å‘Šè­¦è§„åˆ™**

```yaml
# æ—¥æ¶ˆè€—è¶…æ ‡
- alert: DailyCreditsExceeded
  expr: |
    sum(bsc_ws_credits_consumed_total) + 
    (rate(bsc_ws_credits_consumed_total[1h]) * 3600 * 
     clamp_min(24 - hour(), 0)) > 1000000
  annotations:
    summary: "é¢„æµ‹ä»Šæ—¥ç§¯åˆ†æ¶ˆè€—å°†è¶…è¿‡100ä¸‡"
    description: "å½“å‰å·²æ¶ˆè€—{{ $value }}"

# ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½
- alert: LowCacheHitRate
  expr: |
    (sum(bsc_ws_credits_saved_by_cache_total) /
     sum(bsc_ws_credits_consumed_total + bsc_ws_credits_saved_by_cache_total)) < 0.5
  for: 1h
  annotations:
    summary: "ç¼“å­˜å‘½ä¸­ç‡ä½äº50%"
```

**æ”¶ç›Š**ï¼š
- âœ… å®æ—¶æˆæœ¬å¯è§ï¼ˆçŸ¥é“çƒ§äº†å¤šå°‘é’±ï¼‰
- âœ… ä¼˜åŒ–æ–¹å‘æ˜ç¡®ï¼ˆå“ªé‡Œæœ€è´µï¼‰
- âœ… é¢„ç®—é¢„è­¦ï¼ˆé¿å…è¶…æ”¯ï¼‰
- âœ… ç¼“å­˜æ•ˆæœå¯è§†åŒ–

**å·¥ä½œé‡**ï¼š0.5å¤©ï¼ˆåŸºäºç°æœ‰Prometheusç³»ç»Ÿï¼‰

---

## ğŸ“Š P2 - é•¿æœŸä¼˜åŒ–ï¼ˆ1-3ä¸ªæœˆï¼‰

### 13. Redis Pipelineæ‰¹é‡æ“ä½œ â­â­â­

**é—®é¢˜**ï¼š
- å½“å‰å•æ¬¡Redisæ“ä½œï¼ˆget/set/existsï¼‰
- ç½‘ç»œå¾€è¿”å¤šï¼ˆRTTé«˜ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**åœºæ™¯1ï¼šæ‰¹é‡æ£€æŸ¥å†·å´æœŸ**
- å½“å‰ï¼šå¾ªç¯è°ƒç”¨ `redis.get(f"cooldown:{ca}")`ï¼ŒNä¸ªCAéœ€è¦Næ¬¡ç½‘ç»œå¾€è¿”
- ä¼˜åŒ–ï¼šä½¿ç”¨Pipelineï¼Œ1æ¬¡ç½‘ç»œå¾€è¿”è·å–æ‰€æœ‰ç»“æœ

**åœºæ™¯2ï¼šæ‰¹é‡è®¾ç½®ç¼“å­˜**
- å½“å‰ï¼šå¾ªç¯è°ƒç”¨ `redis.set()`
- ä¼˜åŒ–ï¼šPipelineæ‰¹é‡set

**åœºæ™¯3ï¼šå¤æ‚åŸå­æ“ä½œ**
- å½“å‰ï¼šå…ˆgetåˆ¤æ–­ï¼Œå†setï¼ˆ2æ¬¡å¾€è¿”ï¼ŒéåŸå­ï¼‰
- ä¼˜åŒ–ï¼šLuaè„šæœ¬ï¼ˆ1æ¬¡å¾€è¿”ï¼ŒåŸå­æ€§ï¼‰

**æ”¶ç›Š**ï¼š
- âœ… å‡å°‘50%ç½‘ç»œå¾€è¿”
- âœ… Redisæ€§èƒ½æå‡2-5x
- âœ… é™ä½Redisè´Ÿè½½

**å·¥ä½œé‡**ï¼š2å¤©

---

### 14. æ•°æ®åº“æ…¢æŸ¥è¯¢ç›‘æ§å’Œä¼˜åŒ– â­â­â­

**é—®é¢˜**ï¼š
- ä¸çŸ¥é“å“ªäº›SQLæ…¢
- ç¼ºå°‘ç´¢å¼•ä¼˜åŒ–

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**é˜¶æ®µ1ï¼šæ…¢æŸ¥è¯¢ç›‘æ§**
- åœ¨ `DatabaseManager` ä¸­è®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´>100msçš„SQL
- å®šæœŸè¾“å‡ºæ…¢æŸ¥è¯¢Top 10
- é›†æˆåˆ°Prometheusï¼ˆ`database_slow_queries_total`ï¼‰

**é˜¶æ®µ2ï¼šæ…¢æŸ¥è¯¢åˆ†æ**
- ä½¿ç”¨ `EXPLAIN` åˆ†ææ…¢æŸ¥è¯¢
- è¯†åˆ«ç¼ºå¤±ç´¢å¼•
- è¯†åˆ«å…¨è¡¨æ‰«æ

**é˜¶æ®µ3ï¼šç´¢å¼•ä¼˜åŒ–**
```sql
-- sol_ws_batch_pool
ALTER TABLE sol_ws_batch_pool 
ADD INDEX idx_batch_active_interval (batch_id, is_active, time_interval);

ALTER TABLE sol_ws_batch_pool
ADD INDEX idx_pair_active (pair_address, is_active);

-- sol_ws_alert_log
ALTER TABLE sol_ws_alert_log
ADD INDEX idx_ca_alert_time (ca, alert_time DESC);

ALTER TABLE sol_ws_alert_log
ADD INDEX idx_template_time (template_id, alert_time DESC);
```

**é˜¶æ®µ4ï¼šæ‰¹é‡æ“ä½œä¼˜åŒ–**
- å‘Šè­¦æ—¥å¿—æ’å…¥ï¼šå¾ªç¯insert â†’ batch insertï¼ˆexecutemanyï¼‰
- é…ç½®åŠ è½½ï¼šå¤šæ¬¡æŸ¥è¯¢ â†’ JOINä¸€æ¬¡æŸ¥è¯¢

**æ”¶ç›Š**ï¼š
- âœ… æ•°æ®åº“è´Ÿè½½é™ä½30-50%
- âœ… æŸ¥è¯¢å“åº”æ—¶é—´å‡å°‘
- âœ… å‡å°‘æ…¢æŸ¥è¯¢

**å·¥ä½œé‡**ï¼š3å¤©

---

### 15. æœ¬åœ°LRUç¼“å­˜ â­â­

**é—®é¢˜**ï¼š
- é«˜é¢‘åªè¯»æ•°æ®ï¼ˆå¦‚fourmemeé»‘åå•ï¼‰ä»ç„¶æŸ¥Redis
- Redisç½‘ç»œå»¶è¿Ÿï¼ˆå³ä½¿å¾ˆå°ï¼Œä¹Ÿæœ‰1-2msï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**ä½¿ç”¨ `cachetools` åº“**ï¼š
- `@cached(cache=TTLCache(maxsize=1000, ttl=60))`
- ç¼“å­˜fourmemeé»‘åå•ï¼ˆTTL=60ç§’ï¼‰
- ç¼“å­˜é…ç½®æ¨¡æ¿ï¼ˆTTL=300ç§’ï¼‰
- ç¼“å­˜å¸¸ç”¨tokenä¿¡æ¯ï¼ˆTTL=30ç§’ï¼‰

**æˆ–ä½¿ç”¨ `functools.lru_cache`**ï¼š
- é€‚åˆå‚æ•°å›ºå®šçš„å‡½æ•°

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ TTLä¸è¦å¤ªé•¿ï¼ˆé¿å…æ•°æ®è¿‡æœŸï¼‰
- âš ï¸ å†…å­˜å ç”¨æ§åˆ¶ï¼ˆmaxsizeé™åˆ¶ï¼‰
- âš ï¸ å¤šè¿›ç¨‹éƒ¨ç½²æ—¶ç¼“å­˜ä¸å…±äº«ï¼ˆéœ€è€ƒè™‘ä¸€è‡´æ€§ï¼‰

**æ”¶ç›Š**ï¼š
- âœ… å‡å°‘Rediså‹åŠ›
- âœ… å“åº”é€Ÿåº¦æ›´å¿«ï¼ˆå†…å­˜è¯»å– vs ç½‘ç»œï¼‰
- âœ… é™ä½ç½‘ç»œå»¶è¿Ÿå½±å“

**å·¥ä½œé‡**ï¼š1å¤©

---

### 16. åŠ¨æ€å†·å´æœŸ â­â­

**é—®é¢˜**ï¼š
- å½“å‰å›ºå®š3åˆ†é’Ÿå†·å´ï¼Œä¸å¤Ÿçµæ´»
- å°ç›˜tokenå‘Šè­¦é¢‘ç¹ï¼ˆå™ªéŸ³å¤šï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æŒ‰å¸‚å€¼/æµåŠ¨æ€§åˆ†çº§**ï¼š
- å¤§ç›˜ï¼ˆå¸‚å€¼>$10Mï¼‰ï¼šå†·å´3åˆ†é’Ÿ
- ä¸­ç›˜ï¼ˆå¸‚å€¼$1M-$10Mï¼‰ï¼šå†·å´5åˆ†é’Ÿ
- å°ç›˜ï¼ˆå¸‚å€¼<$1Mï¼‰ï¼šå†·å´10åˆ†é’Ÿ

**æˆ–æŒ‰ç”¨æˆ·åå¥½é…ç½®**ï¼š
- ç”¨æˆ·Aï¼šæ¿€è¿›å‹ï¼ˆ2åˆ†é’Ÿå†·å´ï¼‰
- ç”¨æˆ·Bï¼šç¨³å¥å‹ï¼ˆ5åˆ†é’Ÿå†·å´ï¼‰
- ç”¨æˆ·Cï¼šä¿å®ˆå‹ï¼ˆ10åˆ†é’Ÿå†·å´ï¼‰

**å®ç°æ–¹å¼**ï¼š
- åœ¨é…ç½®ä¸­å®šä¹‰åˆ†çº§è§„åˆ™
- å‘Šè­¦æ—¶æ ¹æ®tokenå¸‚å€¼åŠ¨æ€è®¡ç®—å†·å´æ—¶é•¿
- æˆ–åœ¨é…ç½®è¡¨ä¸­ä¸ºæ¯ä¸ªæ¨¡æ¿è®¾ç½®ä¸åŒå†·å´æœŸ

**æ”¶ç›Š**ï¼š
- âœ… å‡å°‘å°ç›˜å™ªéŸ³
- âœ… é‡è¦tokenå‘Šè­¦æ›´åŠæ—¶
- âœ… ç”¨æˆ·ä½“éªŒæå‡

**å·¥ä½œé‡**ï¼š1å¤©

---

### 17. å‘Šè­¦èšåˆ â­â­

**é—®é¢˜**ï¼š
- çŸ­æ—¶é—´å†…å¤šä¸ªtokenè§¦å‘ â†’ å¤šæ¡æ¶ˆæ¯ï¼ˆåˆ·å±ï¼‰
- ç”¨æˆ·ä½“éªŒå·®

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šæ—¶é—´çª—å£èšåˆ**
- 5åˆ†é’Ÿçª—å£å†…ï¼Œç›¸åŒæ¨¡æ¿çš„å¤šä¸ªtokenèšåˆä¸º1æ¡æ¶ˆæ¯
- æ¶ˆæ¯æ ¼å¼ï¼š"3ä¸ªtokenåŒæ—¶æ¶¨å¹…>10%: ABC, DEF, XYZ"

**æ–¹æ¡ˆ2ï¼šç”¨æˆ·çº§é™æµ**
- åŒä¸€ç”¨æˆ·10åˆ†é’Ÿå†…æœ€å¤š10æ¡å‘Šè­¦
- è¶…è¿‡é™åˆ¶çš„å‘Šè­¦å…ˆæ’é˜Ÿï¼Œæ±‡æ€»åå‘é€

**æ–¹æ¡ˆ3ï¼šä¼˜å…ˆçº§æ’åº**
- å¤§ç›˜tokenä¼˜å…ˆå‘é€
- å°ç›˜tokené™ä½ä¼˜å…ˆçº§æˆ–èšåˆå‘é€

**æ”¶ç›Š**ï¼š
- âœ… é¿å…åˆ·å±
- âœ… æå‡é‡è¦å‘Šè­¦èƒ½è§åº¦
- âœ… ç”¨æˆ·ä½“éªŒæå‡

**å·¥ä½œé‡**ï¼š2å¤©

---

### 18. é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰â­â­

**é—®é¢˜**ï¼š
- æ— æ³•è¿½è¸ªå®Œæ•´è¯·æ±‚é“¾è·¯
- éš¾ä»¥å®šä½æ…¢åœ¨å“ªä¸ªç¯èŠ‚

**å®æ–½æ–¹æ¡ˆ**ï¼š

**é›†æˆOpenTelemetry**ï¼š
- å®‰è£… `opentelemetry-api` å’Œ `opentelemetry-sdk`
- é…ç½®Jaegerä½œä¸ºåç«¯

**è¿½è¸ªç‚¹**ï¼š
- WebSocketæ¶ˆæ¯æ¥æ”¶
- APIè°ƒç”¨ï¼ˆDBotXã€GMGNï¼‰
- RPCè°ƒç”¨
- æ•°æ®åº“æŸ¥è¯¢
- Redisæ“ä½œ
- é€šçŸ¥å‘é€

**æ”¶ç›Š**ï¼š
- âœ… å¯è§†åŒ–è¯·æ±‚é“¾è·¯
- âœ… è¯†åˆ«æ…¢è·¯å¾„ï¼ˆå¦‚æŸä¸ªAPIæ€»æ˜¯æ…¢ï¼‰
- âœ… å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ

**å·¥ä½œé‡**ï¼š2å¤©

---

### 19. Sentryé”™è¯¯è¿½è¸ª â­â­

**é—®é¢˜**ï¼š
- çº¿ä¸Šå¼‚å¸¸éœ€è¦æŸ¥æ—¥å¿—æ‰èƒ½å‘ç°
- ç¼ºå°‘å¼‚å¸¸èšåˆå’Œåˆ†æ

**å®æ–½æ–¹æ¡ˆ**ï¼š

**é›†æˆSentry**ï¼š
- æ³¨å†ŒSentryè´¦å·
- å®‰è£… `sentry-sdk`
- åˆå§‹åŒ–Sentryï¼ˆåœ¨main.pyå…¥å£ï¼‰

**è‡ªåŠ¨ä¸ŠæŠ¥**ï¼š
- æ‰€æœ‰æœªæ•è·å¼‚å¸¸
- å¸¦å®Œæ•´å †æ ˆä¿¡æ¯
- å¸¦ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆtokenã€chainã€batch_idï¼‰

**å¼‚å¸¸åˆ†æ**ï¼š
- æŒ‰é¢‘ç‡æ’åº
- æŒ‰å½±å“ç”¨æˆ·æ•°æ’åº
- Issueè‡ªåŠ¨åˆ›å»ºå’Œåˆ†é…

**æ”¶ç›Š**ï¼š
- âœ… ä¸»åŠ¨å‘ç°é—®é¢˜ï¼ˆè€Œä¸æ˜¯ç­‰ç”¨æˆ·æŠ¥å‘Šï¼‰
- âœ… æŒ‰ä¼˜å…ˆçº§ä¿®å¤é«˜é¢‘bug
- âœ… å†å²å¼‚å¸¸è¶‹åŠ¿åˆ†æ

**å·¥ä½œé‡**ï¼š1å¤©

---

### 20. é…ç½®çƒ­æ›´æ–° â­

**é—®é¢˜**ï¼š
- ä¿®æ”¹é…ç½®éœ€è¦é‡å¯æœåŠ¡
- å½±å“å¯ç”¨æ€§

**å®æ–½æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼šæ–‡ä»¶ç›‘å¬**
- ä½¿ç”¨ `watchdog` åº“ç›‘å¬é…ç½®æ–‡ä»¶
- æ–‡ä»¶ä¿®æ”¹æ—¶è§¦å‘reload
- æ›´æ–°å†…å­˜ä¸­çš„é…ç½®å¯¹è±¡

**æ–¹æ¡ˆBï¼šRedis Pub/Sub**
- åå°ç®¡ç†ç³»ç»Ÿä¿®æ”¹é…ç½®åå‘å¸ƒæ¶ˆæ¯åˆ°Redis
- Monitorè®¢é˜… `config:update` é¢‘é“
- æ”¶åˆ°æ¶ˆæ¯åreloadé…ç½®

**æ–¹æ¡ˆCï¼šå®šæœŸè½®è¯¢**
- æ¯5åˆ†é’Ÿæ£€æŸ¥é…ç½®æ–‡ä»¶ä¿®æ”¹æ—¶é—´
- å¦‚æœå˜åŒ–ï¼Œåˆ™reload

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ é…ç½®æ ¡éªŒï¼ˆreloadå‰å…ˆéªŒè¯é…ç½®åˆæ³•æ€§ï¼‰
- âš ï¸ åŸå­æ›´æ–°ï¼ˆé¿å…éƒ¨åˆ†æ›´æ–°å¯¼è‡´ä¸ä¸€è‡´ï¼‰
- âš ï¸ Reloadå¤±è´¥å¤„ç†ï¼ˆä¿ç•™æ—§é…ç½®ï¼‰

**æ”¶ç›Š**ï¼š
- âœ… ä¿®æ”¹é…ç½®é›¶åœæœº
- âœ… å¿«é€Ÿè°ƒæ•´é˜ˆå€¼ï¼ˆå®éªŒä¸åŒé…ç½®ï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

## ğŸ¯ ä¼˜å…ˆçº§æ€»ç»“

### **âœ… å·²å®Œæˆä¼˜åŒ–ï¼ˆ2025-11-04 ~ 2025-11-09ï¼‰**

| ä¼˜åŒ–é¡¹ | å®é™…å·¥ä½œé‡ | æ”¶ç›Š | å®Œæˆæ—¥æœŸ | çŠ¶æ€ |
|--------|----------|------|---------|------|
| ~~1. ç›´æ¥å¤„ç†æ¨¡å¼æ¶æ„~~ | 1å¤© | å¤„ç†èƒ½åŠ›2.5xï¼Œ0ä¸¢æ¶ˆæ¯ï¼Œå»¶è¿Ÿ-80% | 2025-11-04 | âœ… å·²éƒ¨ç½² |
| ~~2. APIå®¢æˆ·ç«¯å¤ç”¨~~ | 2å°æ—¶ | APIæˆåŠŸç‡70%â†’94% | 2025-11-04 | âœ… å·²éƒ¨ç½² |
| ~~3. Chainstackè¿ç§»~~ | 1å°æ—¶ | åˆ é™¤é™æµæœºåˆ¶ï¼Œç®€åŒ–ä»£ç 150è¡Œ | 2025-11-04 | âœ… å·²éƒ¨ç½² |
| ~~4. Telegram HTTP API + ç›‘æ§ä¼˜åŒ–~~ | 4å°æ—¶ | æ¶æ„ç»Ÿä¸€ï¼Œä¸šåŠ¡ç›‘æ§å¯è§†åŒ– | 2025-11-05 | âœ… å·²éƒ¨ç½² |
| ~~5. Prometheus Metrics~~ | 2å°æ—¶ | å®æ—¶ç›‘æ§ï¼Œå¯è§†åŒ–Dashboard | 2025-11-05 | âœ… å·²éƒ¨ç½² |
| ~~8. çº¿ç¨‹æ± å¼‚å¸¸å¤„ç† + Cooldownä¿æŠ¤~~ | 3å°æ—¶ | ä¿®å¤token"é”æ­»"é—®é¢˜ï¼Œå¼‚å¸¸å…¨å¯è¿½è¸ª | 2025-11-08 | âœ… å·²éƒ¨ç½² |
| ~~9. Redisç¼“å­˜ä¼˜åŒ–~~ | 2å°æ—¶ | fourmemeç™½åå•ï¼ŒTTLä¼˜åŒ–ï¼Œå†…å­˜-75% | 2025-11-08 | âœ… å·²éƒ¨ç½² |
| ~~10. å¤–ç›˜é€»è¾‘ä¿®å¤~~ | 3å°æ—¶ | å¤–ç›˜ä¹°å•è¯†åˆ«ç‡50%â†’100% | 2025-11-09 | âœ… å·²éƒ¨ç½² |
| ~~11. å†…ç›˜é€»è¾‘ä¿®å¤ï¼ˆ8é¡¹ï¼‰~~ | 5å°æ—¶ | å†…ç›˜è¦†ç›–ç‡æå‡ï¼ŒABIè§£ç ç¨³å®šæ€§100% | 2025-11-09 | âœ… å·²éƒ¨ç½² |
| ~~12. RPCé™æµä¼˜åŒ–~~ | 10åˆ†é’Ÿ | é¢„æœŸ429é”™è¯¯é™ä½90% | 2025-11-09 | âœ… å·²éƒ¨ç½² |
| ~~13. ä»£ç é‡æ„ï¼ˆç»Ÿä¸€æ’­æŠ¥ï¼‰~~ | 2å°æ—¶ | å‡å°‘25è¡Œé‡å¤ä»£ç ï¼Œç»´æŠ¤æ€§æå‡ | 2025-11-09 | âœ… å·²éƒ¨ç½² |
| ~~14. å¥åº·æ£€æŸ¥ç»Ÿè®¡BUG~~ | 10åˆ†é’Ÿ | ç»Ÿè®¡å‡†ç¡®ï¼Œæ—¥å¿—é€»è¾‘ä¸€è‡´ | 2025-11-09 | âœ… å·²éƒ¨ç½² |

**æ€»è®¡ï¼š~3.5å¤©ï¼Œæ ¸å¿ƒé—®é¢˜å…¨éƒ¨è§£å†³**

**å…³é”®æˆæœ**ï¼š
- âœ… **é˜Ÿåˆ—æ¨¡å¼ â†’ ç›´æ¥å¤„ç†æ¨¡å¼**ï¼ˆç»éªŒæ•™è®­ï¼šé˜Ÿåˆ—ä¸æ˜¯é“¶å¼¹ï¼ï¼‰
- âœ… **æ¶ˆæ¯ä¸¢å¤±ç‡ï¼š60% â†’ 0%**
- âœ… **å¤„ç†å»¶è¿Ÿé™ä½80%**
- âœ… **ä»£ç ç®€åŒ–885è¡Œ**ï¼ˆ150è¡Œé™æµ + 210è¡Œé˜Ÿåˆ— + 500è¡ŒåºŸå¼ƒ + 25è¡Œé‡å¤ï¼‰
- âœ… **Telegramæ¶æ„ç»Ÿä¸€**ï¼ˆæ‰€æœ‰æ¨¡å—ä½¿ç”¨HTTP APIï¼‰
- âœ… **å¥åº·æ£€æŸ¥ä¼˜åŒ–**ï¼ˆä¸šåŠ¡æŒ‡æ ‡ä¸ºä¸»ï¼Œä»·å€¼æå‡ï¼‰
- âœ… **å¼‚å¸¸å¤„ç†å®Œå–„**ï¼ˆçº¿ç¨‹æ± å¼‚å¸¸æ•è·ï¼Œcooldownè‡ªåŠ¨è§£é”ï¼‰
- âœ… **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼ˆfourmemeç™½åå•èŠ‚çœ90% APIè°ƒç”¨ï¼ŒRediså†…å­˜å ç”¨-75%ï¼‰
- âœ… **å¤–ç›˜æ¼å•ä¿®å¤**ï¼ˆç¨³å®šå¸ä½ç½®åŠ¨æ€åˆ¤æ–­ï¼Œè¯†åˆ«ç‡ä»50%â†’100%ï¼‰
- âœ… **å†…ç›˜æ¼å•ä¿®å¤**ï¼ˆ8é¡¹æ”¹è¿›ï¼šABIè§£ç ã€åŠ¨æ€Proxyã€é›¶åœ°å€é“¸é€ ã€ä¸¤è·³è·¯ç”±ã€WBNBæ”¯ä»˜ç­‰ï¼‰
- âœ… **RPC 429ä¼˜åŒ–**ï¼ˆä»1000 RPSé™è‡³25 RPSï¼Œé™ä½40å€è¯·æ±‚é¢‘ç‡ï¼‰
- âœ… **ä»£ç é‡æ„å®Œæˆ**ï¼ˆç»Ÿä¸€æ’­æŠ¥å‡½æ•°ï¼ŒDRYåŸåˆ™ï¼Œç»´æŠ¤æ€§æå‡ï¼‰
- âœ… **å¥åº·æ£€æŸ¥BUGä¿®å¤**ï¼ˆç»Ÿè®¡é€»è¾‘å‡†ç¡®ï¼Œæ—¥å¿—ä¸€è‡´æ€§ï¼‰

---

### **å¾…å®æ–½ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰**

| ä¼˜åŒ–é¡¹ | å·¥ä½œé‡ | æ”¶ç›Š | ä¼˜å…ˆçº§ |
|--------|--------|------|--------|
| 7. å¥åº·æ£€æŸ¥+ä¼˜é›…å…³é—­ | 1å°æ—¶ | ç”Ÿäº§ç¨³å®šæ€§ä¿éšœ | â­â­â­â­ |
| 6. JSONæ—¥å¿—å¼€å¯ | 5åˆ†é’Ÿ | ä¾¿äºæ—¥å¿—é‡‡é›†å’Œåˆ†æ | â­â­â­ |

**P0å¾…å®Œæˆæ€»è®¡ï¼š~1å°æ—¶**

**P0å·²å®Œæˆï¼ˆ2025-11-05ï¼‰**ï¼š
| ä¼˜åŒ–é¡¹ | å®é™…å·¥ä½œé‡ | æ ¸å¿ƒæ”¶ç›Š |
|--------|-----------|---------|
| 1. ç›´æ¥å¤„ç†æ¨¡å¼æ¶æ„ | 2å°æ—¶ | 2.5xæ€§èƒ½æå‡ï¼Œ0ä¸¢æ¶ˆæ¯ |
| 2. APIå®¢æˆ·ç«¯èµ„æºæ³„æ¼ä¿®å¤ | 1å°æ—¶ | è¿æ¥å¤ç”¨ï¼ŒTLSæ¡æ‰‹èŠ‚çœ |
| 3. Chainstackè¿ç§»+ç§»é™¤é™æµ | 30åˆ†é’Ÿ | æ— é™åˆ¶RPCï¼Œæ¶æ„ç®€åŒ– |
| 4. Telegram HTTP APIè¿ç§» | 1å°æ—¶ | ç»Ÿä¸€é€šçŸ¥æ¶æ„ï¼Œå¥åº·æ£€æŸ¥ä¼˜åŒ– |
| 5. Prometheus Metrics | 2å°æ—¶ | å®æ—¶ç›‘æ§ï¼Œå¯è§†åŒ–Dashboard |

**P0å·²å®Œæˆæ€»è®¡ï¼š~6.5å°æ—¶**

---

### **ä¸­æœŸå®æ–½ï¼ˆ2å‘¨å†…ï¼Œæ€»è®¡6å¤©ï¼‰**

| ä¼˜åŒ–é¡¹ | å·¥ä½œé‡ | æ”¶ç›Š | ä¼˜å…ˆçº§ |
|--------|--------|------|--------|
| 10. é…ç½®é›†ä¸­åŒ– | 1å¤© | ç»´æŠ¤æ€§å¤§å¹…æå‡ | â­â­â­â­ |
| 11. æŒ‡æ ‡é™çº§ä¼˜åŒ– | 5åˆ†é’Ÿ-1å¤© | å‡å°‘æ¼æŠ¥ | â­â­â­ |
| 12. å•å…ƒæµ‹è¯•+CI | 1å¤© | è´¨é‡ä¿éšœ | â­â­â­â­ |
| 13. ä¸šåŠ¡ç›‘æ§å‘Šè­¦ | 1å¤© | ä¸»åŠ¨è¿ç»´ | â­â­â­ |
| **14. å‘Šè­¦å¯é æ€§ä¿éšœ** | 1å¤© | é›¶æ¼æŠ¥ï¼Œè‡ªåŠ¨é‡è¯• | â­â­â­â­â­ |
| **15. ç¼“å­˜åˆ†çº§TTLç­–ç•¥** | 2å¤© | å†…å­˜ä¼˜åŒ–ï¼Œå‘½ä¸­ç‡æå‡ | â­â­â­â­ |
| **16. APIæˆæœ¬ç›‘æ§** | 0.5å¤© | æˆæœ¬å¯è§ï¼Œé¢„ç®—é¢„è­¦ | â­â­â­â­ |

**æ€»è®¡ï¼š~6å¤©**

**æ–°å¢è¯´æ˜**ï¼š
- âœ… å‘Šè­¦å¯é æ€§ï¼ˆé‡è¯•é˜Ÿåˆ—+æ­»ä¿¡é˜Ÿåˆ—ï¼‰- é¿å…Telegramä¸´æ—¶æ•…éšœå¯¼è‡´æ¼æŠ¥
- âœ… ç¼“å­˜åˆ†çº§ï¼ˆL1/L2/L3å¤šçº§ç¼“å­˜ï¼‰- æå‡æ€§èƒ½ï¼Œé™ä½Rediså‹åŠ›
- âœ… APIæˆæœ¬ç›‘æ§ï¼ˆå®æ—¶æ¶ˆè€—+é¢„ç®—é¢„è­¦ï¼‰- é¿å…DBotXç§¯åˆ†è¶…æ”¯
- asyncioåŒ–å·²ä»P1ç§»è‡³P2ï¼ˆä¼˜å…ˆçº§ä¸‹è°ƒï¼‰
- å½“å‰ç›´æ¥å¤„ç†æ¨¡å¼å·²æ»¡è¶³æ€§èƒ½éœ€æ±‚
- é‡ç‚¹è½¬å‘å¯ç»´æŠ¤æ€§ã€å¯é æ€§å’Œå¯è§‚æµ‹æ€§

---

### **é•¿æœŸä¼˜åŒ–ï¼ˆ1-3ä¸ªæœˆï¼ŒæŒ‰éœ€å®æ–½ï¼‰**

| ä¼˜åŒ–é¡¹ | å·¥ä½œé‡ | æ”¶ç›Š | ä¼˜å…ˆçº§ |
|--------|--------|------|--------|
| 8. å®Œå…¨asyncioåŒ– | 3å¤© | åç¨‹æ›´é«˜æ•ˆï¼ˆé•¿æœŸç›®æ ‡ï¼‰ | â­â­â­ |
| 13. Redis Pipeline | 2å¤© | 2-5x Redisæ€§èƒ½æå‡ | â­â­â­ |
| 14. æ•°æ®åº“æ…¢æŸ¥è¯¢ä¼˜åŒ– | 3å¤© | 30-50%æ•°æ®åº“è´Ÿè½½é™ä½ | â­â­â­ |
| 15. æœ¬åœ°LRUç¼“å­˜ | 1å¤© | å‡å°‘Rediså‹åŠ› | â­â­ |
| 16. åŠ¨æ€å†·å´æœŸ | 1å¤© | ç”¨æˆ·ä½“éªŒæå‡ | â­â­ |
| 17. å‘Šè­¦èšåˆ | 2å¤© | é¿å…åˆ·å± | â­â­ |
| 18. OpenTelemetryé“¾è·¯è¿½è¸ª | 2å¤© | æ·±åº¦æ€§èƒ½åˆ†æ | â­â­ |
| 19. Sentryé”™è¯¯è¿½è¸ª | 1å¤© | ä¸»åŠ¨å‘ç°bug | â­â­ |
| 20. é…ç½®çƒ­æ›´æ–° | 2å¤© | é›¶åœæœºé…ç½®å˜æ›´ | â­ |

**æ€»è®¡ï¼š~17å¤©ï¼ˆæŒ‰éœ€é€‰æ‹©å®æ–½ï¼‰**

**è¯´æ˜**ï¼š
- asyncioåŒ–ç§»è‡³æ­¤å¤„ï¼Œä½œä¸ºé•¿æœŸä¼˜åŒ–ç›®æ ‡
- å½“å‰æ¶æ„å·²è¶³å¤Ÿç¨³å®šå’Œé«˜æ•ˆ
- ä¼˜å…ˆå®Œæˆå¯è§‚æµ‹æ€§å’Œå¯ç»´æŠ¤æ€§æ”¹è¿›

---

## ğŸ’¡ å®æ–½å»ºè®®

### **é˜¶æ®µåˆ’åˆ†**

**ç¬¬1å‘¨ï¼ˆP0ï¼‰**ï¼š
- âœ… å¿«é€Ÿä¿®å¤æ€§èƒ½ç“¶é¢ˆå’Œèµ„æºæ³„æ¼
- âœ… å»ºç«‹å¯è§‚æµ‹æ€§åŸºç¡€ï¼ˆMetrics + JSONæ—¥å¿—ï¼‰
- âœ… ç¡®ä¿ç”Ÿäº§ç¨³å®šæ€§ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- ğŸ¯ **ç›®æ ‡**ï¼šç³»ç»Ÿæ›´ç¨³å®šã€é—®é¢˜å¯ç›‘æ§

**ç¬¬2å‘¨ï¼ˆP1ï¼‰**ï¼š
- âœ… é…ç½®é›†ä¸­åŒ–
- âœ… å•å…ƒæµ‹è¯•+CI
- âœ… ä¸šåŠ¡ç›‘æ§å‘Šè­¦
- âœ… æŒ‡æ ‡é™çº§ä¼˜åŒ–
- ğŸ¯ **ç›®æ ‡**ï¼šè´¨é‡ä¿éšœã€è¿ç»´è‡ªåŠ¨åŒ–ã€å¯ç»´æŠ¤æ€§æå‡

**ç¬¬2-3ä¸ªæœˆï¼ˆP2æŒ‰éœ€ï¼‰**ï¼š
- æ ¹æ®å®é™…è¿è¡Œæƒ…å†µé€‰æ‹©æ€§å®æ–½P2ä¼˜åŒ–
- é‡ç‚¹å…³æ³¨ç”¨æˆ·åé¦ˆçš„ç—›ç‚¹
- ğŸ¯ **ç›®æ ‡**ï¼šæŒç»­ä¼˜åŒ–ã€ç²¾ç›Šæ±‚ç²¾

---

### **é£é™©æ§åˆ¶**

**1. åˆ†æ¨¡å—å®æ–½ï¼Œé¿å…ä¸€æ¬¡æ€§å¤§æ”¹**
- å…ˆæ”¹BSC monitorï¼Œè§‚å¯Ÿ1å‘¨
- å†æ”¹SOL monitor
- æœ€åæ”¹å…¶ä»–æ¨¡å—

**2. å……åˆ†æµ‹è¯•**
- å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
- é›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
- ç°åº¦å‘å¸ƒï¼ˆ10% â†’ 50% â†’ 100%ï¼‰

**3. ä¿ç•™å›æ»šèƒ½åŠ›**
- Git tagæ ‡è®°æ¯ä¸ªç‰ˆæœ¬
- Dockeré•œåƒä¿ç•™æ—§ç‰ˆæœ¬
- é…ç½®ä¿ç•™å¤‡ä»½

**4. ç›‘æ§å’Œå‘Šè­¦**
- å…ˆå»ºç«‹Prometheusç›‘æ§
- é…ç½®å‘Šè­¦è§„åˆ™
- æœ‰é—®é¢˜ç«‹å³å‘ç°

---

### **æˆåŠŸæŒ‡æ ‡ï¼ˆKPIï¼‰**

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- âœ… æ¶ˆæ¯å¤„ç†å»¶è¿Ÿp95 < 1ç§’ï¼ˆå½“å‰å¯èƒ½5-10ç§’ï¼‰
- âœ… APIæˆåŠŸç‡ > 95%ï¼ˆå½“å‰~94%ï¼‰
- âœ… WebSocketè¿æ¥ç¨³å®šæ€§ > 99.9%

**å¯é æ€§æŒ‡æ ‡**ï¼š
- âœ… ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%ï¼ˆæ¯æœˆåœæœºæ—¶é—´<43åˆ†é’Ÿï¼‰
- âœ… å‘Šè­¦é›¶æ¼æŠ¥ï¼ˆé‡è¦äº‹ä»¶100%è§¦å‘ï¼‰
- âœ… æ•°æ®é›¶ä¸¢å¤±ï¼ˆä¼˜é›…å…³é—­ï¼‰

**è¿ç»´æŒ‡æ ‡**ï¼š
- âœ… MTTRï¼ˆå¹³å‡æ¢å¤æ—¶é—´ï¼‰< 5åˆ†é’Ÿ
- âœ… é…ç½®å˜æ›´0åœæœº
- âœ… éƒ¨ç½²æ—¶é—´ < 2åˆ†é’Ÿ

---

## ğŸ“š é™„å½•

### **ç›¸å…³æ–‡æ¡£**

- [æ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—](./LOGGING_SYSTEM.md)
- [BSC APIä¼˜åŒ–æ–¹æ¡ˆ](./BSC_API_OPTIMIZATION.md)
- [SOL WebSocketè®¾è®¡æ–‡æ¡£](./SOL_WEBSOCKET_MONITOR_DESIGN.md)

### **æŠ€æœ¯æ ˆå‡çº§**

**æ–°å¢ä¾èµ–**ï¼š
```txt
# å¼‚æ­¥IO
aiomysql==0.2.0

# ç›‘æ§
prometheus-client==0.19.0

# æµ‹è¯•
pytest==7.4.3
pytest-asyncio==0.21.1

# å¥åº·æ£€æŸ¥
fastapi==0.109.0
uvicorn==0.27.0

# é…ç½®ç®¡ç†
pyyaml==6.0.1
pydantic==2.5.0

# å¯é€‰ï¼šé”™è¯¯è¿½è¸ª
sentry-sdk==1.39.0

# å¯é€‰ï¼šé“¾è·¯è¿½è¸ª
opentelemetry-api==1.21.0
opentelemetry-sdk==1.21.0
```

### **è”ç³»æ–¹å¼**

- æŠ€æœ¯è®¨è®ºï¼š[GitHub Issues](https://github.com/your-repo/issues)
- ç´§æ€¥é—®é¢˜ï¼šTelegram @ops_channel

---

## ğŸ“ˆ å½“å‰é¡¹ç›®çŠ¶æ€ï¼ˆ2025-11-08ï¼‰

### **ğŸ¯ æ ¸å¿ƒæŒ‡æ ‡**

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| **æ¶ˆæ¯å¤„ç†èƒ½åŠ›** | ~40 msg/s | 50 msg/s | âœ… è¾¾æ ‡ |
| **æ¶ˆæ¯ä¸¢å¤±ç‡** | 0% | <0.1% | âœ… ä¼˜ç§€ |
| **å¤„ç†å»¶è¿ŸP95** | <1s | <2s | âœ… ä¼˜ç§€ |
| **APIæˆåŠŸç‡** | ~94% | >95% | âš ï¸ æ¥è¿‘ |
| **å‘Šè­¦é›¶æ¼æŠ¥** | 0ï¼ˆå·²ä¿®å¤é”æ­»bugï¼‰ | 0 | âœ… è¾¾æ ‡ |
| **Rediså†…å­˜å ç”¨** | ~3.6MB | <10MB | âœ… ä¼˜ç§€ |
| **ç³»ç»Ÿå¯ç”¨æ€§** | >99.5% | >99.9% | âš ï¸ æ¥è¿‘ |

### **ğŸš€ å·²è§£å†³çš„å…³é”®é—®é¢˜**

1. âœ… **æ¶æ„æ€§èƒ½é—®é¢˜**ï¼ˆé˜Ÿåˆ—ç“¶é¢ˆ â†’ ç›´æ¥å¤„ç†ï¼‰
2. âœ… **èµ„æºæ³„æ¼é—®é¢˜**ï¼ˆAPIå®¢æˆ·ç«¯å¤ç”¨ï¼‰
3. âœ… **å¼‚å¸¸å¤„ç†ç¼ºé™·**ï¼ˆçº¿ç¨‹æ± å¼‚å¸¸æ•è· + cooldownä¿æŠ¤ï¼‰
4. âœ… **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼ˆfourmemeç™½åå•ï¼ŒTTLè°ƒæ•´ï¼‰
5. âœ… **RPCé™æµç§»é™¤**ï¼ˆChainstackæ— é™åˆ¶èŠ‚ç‚¹ï¼‰
6. âœ… **ç›‘æ§å¯è§†åŒ–**ï¼ˆPrometheus + Grafanaï¼‰

### **âš ï¸ å½“å‰å·²çŸ¥é—®é¢˜**

1. âš ï¸ **ç¼ºå°‘å‘Šè­¦é‡è¯•æœºåˆ¶**ï¼ˆTelegramä¸´æ—¶æ•…éšœå¯èƒ½ä¸¢å¤±å‘Šè­¦ï¼‰
   - è§£å†³æ–¹æ¡ˆï¼šP1#14 å‘Šè­¦å¯é æ€§ä¿éšœï¼ˆ1å¤©å·¥ä½œé‡ï¼‰
   
2. âš ï¸ **ç¼ºå°‘å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼ˆK8s/Dockeræ— æ³•åˆ¤æ–­æœåŠ¡çŠ¶æ€ï¼‰
   - è§£å†³æ–¹æ¡ˆï¼šP0#7 å¥åº·æ£€æŸ¥+ä¼˜é›…å…³é—­ï¼ˆ1å°æ—¶å·¥ä½œé‡ï¼‰
   
3. âš ï¸ **APIæˆæœ¬ä¸é€æ˜**ï¼ˆä¸çŸ¥é“æ¯å¤©çƒ§äº†å¤šå°‘ç§¯åˆ†ï¼‰
   - è§£å†³æ–¹æ¡ˆï¼šP1#16 APIæˆæœ¬ç›‘æ§ï¼ˆ0.5å¤©å·¥ä½œé‡ï¼‰
   
4. âš ï¸ **æ— å•å…ƒæµ‹è¯•**ï¼ˆé‡æ„é£é™©é«˜ï¼‰
   - è§£å†³æ–¹æ¡ˆï¼šP1#12 å•å…ƒæµ‹è¯•+CIï¼ˆ1å¤©å·¥ä½œé‡ï¼‰

### **ğŸ“Š ä»£ç è´¨é‡è¯„ä¼°**

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ¶æ„è®¾è®¡** | â­â­â­â­â­ | ç›´æ¥å¤„ç†æ¨¡å¼ç®€å•é«˜æ•ˆï¼Œæ— è¿‡åº¦è®¾è®¡ |
| **å¯é æ€§** | â­â­â­â­ | å¼‚å¸¸å¤„ç†å®Œå–„ï¼Œcooldownä¿æŠ¤ï¼Œç¼ºé‡è¯•æœºåˆ¶ |
| **æ€§èƒ½** | â­â­â­â­â­ | 0ä¸¢æ¶ˆæ¯ï¼Œä½å»¶è¿Ÿï¼Œé«˜åå |
| **å¯è§‚æµ‹æ€§** | â­â­â­â­ | Prometheusç›‘æ§ï¼Œæ—¥å¿—å®Œå–„ï¼Œç¼ºAPM |
| **å¯ç»´æŠ¤æ€§** | â­â­â­ | é…ç½®åˆ†æ•£ï¼Œç¼ºå•å…ƒæµ‹è¯•ï¼Œæ–‡æ¡£å®Œå–„ |
| **æˆæœ¬æ§åˆ¶** | â­â­â­ | ç¼“å­˜ä¼˜åŒ–ï¼Œä½†æˆæœ¬å¯è§æ€§ä¸è¶³ |

**ç»¼åˆè¯„åˆ†**ï¼šâ­â­â­â­ / 5.0ï¼ˆç”Ÿäº§å¯ç”¨ï¼Œæœ‰ä¼˜åŒ–ç©ºé—´ï¼‰

### **ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

#### **æœ¬å‘¨ä¼˜å…ˆ**ï¼ˆç´§æ€¥+é«˜æ”¶ç›Šï¼‰ï¼š
1. âœ… å¥åº·æ£€æŸ¥+ä¼˜é›…å…³é—­ï¼ˆ1å°æ—¶ï¼‰
2. âœ… APIæˆæœ¬ç›‘æ§ï¼ˆ0.5å¤©ï¼‰
3. âœ… å‘Šè­¦å¯é æ€§ä¿éšœï¼ˆ1å¤©ï¼‰

#### **æœ¬æœˆè®¡åˆ’**ï¼ˆé‡è¦ä¼˜åŒ–ï¼‰ï¼š
4. âœ… é…ç½®é›†ä¸­åŒ–ï¼ˆ1å¤©ï¼‰
5. âœ… å•å…ƒæµ‹è¯•+CIï¼ˆ1å¤©ï¼‰
6. âœ… ä¸šåŠ¡ç›‘æ§å‘Šè­¦ï¼ˆ1å¤©ï¼‰

#### **å­£åº¦ç›®æ ‡**ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰ï¼š
- ç¼“å­˜åˆ†çº§TTLç­–ç•¥ï¼ˆ2å¤©ï¼‰
- æ•°æ®åº“æ‰¹é‡æ“ä½œï¼ˆ1å¤©ï¼‰
- asyncioåŒ–é‡æ„ï¼ˆ3å¤©ï¼ŒæŒ‰éœ€ï¼‰

**é¢„ä¼°å·¥ä½œé‡**ï¼šæœ¬å‘¨2.5å¤©ï¼Œæœ¬æœˆ6å¤©ï¼Œå­£åº¦å†…10-15å¤©

---

**Document Version**: v3.1  
**Last Updated**: 2025-11-09  
**Next Review**: 2025-12-09

